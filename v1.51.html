<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¿®ä»™æ¨¡æ‹Ÿå™¨v1.5-ä¸¹è¯é‡æ„ç‰ˆ</title>
    <style>
        /* ==================== åŸæœ‰æ ·å¼ä¿æŒä¸å˜ ==================== */
        :root {
            --primary-color: #00BCD4;
            --primary-glow: rgba(0, 188, 212, 0.8);
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-hover: #1e2a4a;
            --text-normal: #ffffff;
            --text-dim: #aaaaaa;
            --text-success: #4CAF50;
            --text-danger: #f44336;
            --text-warning: #FFC107;
            --border-color: #2a3f5f;
            --shadow-glow: 0 0 25px rgba(0, 255, 255, 0.3);
            
            --font-size-xs: clamp(10px, 1.5vw, 12px);
            --font-size-sm: clamp(12px, 2vw, 14px);
            --font-size-md: clamp(14px, 2.5vw, 16px);
            --font-size-lg: clamp(18px, 3vw, 24px);
            --font-size-xl: clamp(24px, 5vw, 36px);
            --font-size-title: clamp(36px, 8vw, 72px);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "å¾®è½¯é›…é»‘", sans-serif;
            background: var(--bg-dark);
            color: var(--text-normal);
            text-align: center;
            padding: min(20px, 2vw);
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
            font-size: var(--font-size-md);
            line-height: 1.4;
        }

        .cover-container {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.5s ease-out;
            padding: 2vw;
        }
        
        .cover-title {
            font-size: var(--font-size-title);
            font-weight: bold;
            color: var(--primary-color);
            text-shadow: 0 0 30px var(--primary-glow);
            margin-bottom: min(50px, 5vh);
            letter-spacing: 0.1em;
            word-wrap: break-word;
            max-width: 90vw;
        }
        
        .cover-subtitle {
            font-size: var(--font-size-lg);
            color: var(--text-dim);
            margin-bottom: min(100px, 10vh);
            font-style: italic;
            max-width: 80vw;
        }
        
        .start-button {
            background: linear-gradient(135deg, #0f3460, var(--primary-color));
            color: white;
            border: none;
            padding: min(20px, 4vw) min(60px, 8vw);
            font-size: var(--font-size-lg);
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 10px 30px var(--primary-glow);
            transition: all 0.3s ease;
            min-width: min(280px, 80vw);
            max-width: 90vw;
            letter-spacing: 0.05em;
        }
        
        .start-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px var(--primary-glow);
        }

        .game-container {
            width: min(1400px, 95vw);
            max-width: 95vw;
            margin: 0 auto;
            background: var(--bg-card);
            padding: min(25px, 3vw);
            border-radius: 15px;
            box-shadow: var(--shadow-glow);
            display: none;
            min-height: 600px;
            max-height: 98vh;
            overflow: hidden;
        }

        .main-layout {
            display: flex;
            gap: min(25px, 3vw);
            height: 100%;
            max-height: calc(98vh - 150px);
        }

        .left-panel {
            flex: 0 0 min(400px, 35vw);
            display: flex;
            flex-direction: column;
            gap: min(15px, 2vh);
            overflow-y: auto;
            padding-right: 5px;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: min(15px, 2vh);
            min-width: 0;
        }

        .collapsible-panel {
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .collapsible-panel:hover {
            border-color: var(--primary-color);
            box-shadow: 0 0 20px var(--primary-glow);
        }

        .panel-header {
            padding: min(12px, 1.5vw);
            background: rgba(0, 188, 212, 0.1);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            font-weight: bold;
            color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .panel-header:hover {
            background: rgba(0, 188, 212, 0.2);
        }

        .panel-header::after {
            content: "â–¼";
            font-size: var(--font-size-sm);
            transition: transform 0.3s ease;
        }

        .collapsible-panel.collapsed .panel-header::after {
            transform: rotate(-90deg);
        }

        .panel-content {
            padding: min(18px, 2vw);
            max-height: 1000px;
            transition: max-height 0.5s ease, padding 0.5s ease;
        }

        .collapsible-panel.collapsed .panel-content {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            overflow: hidden;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: min(8px, 1vh) 0;
            font-size: var(--font-size-md);
            padding: min(3px, 0.5vh) 0;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .stat-label {
            color: var(--text-dim);
            font-size: var(--font-size-sm);
            flex-shrink: 0;
        }
        
        .stat-value {
            font-weight: bold;
            color: var(--text-normal);
            word-break: break-word;
            flex-shrink: 1;
            min-width: 0;
        }

        .progress-container {
            margin: min(10px, 1.5vh) 0;
            height: min(22px, 3vw);
            background: var(--bg-card);
            border-radius: 11px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            width: 100%;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), #00FFFF);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: min(8px, 1vw);
            font-size: var(--font-size-xs);
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            white-space: nowrap;
        }

        button {
            background: linear-gradient(135deg, #0f3460, #1e5a8c);
            color: white;
            border: none;
            padding: min(14px, 2vw) min(20px, 3vw);
            border-radius: 8px;
            cursor: pointer;
            font-size: var(--font-size-md);
            transition: all 0.2s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0,0.3);
            margin: min(5px, 1vw);
            min-width: min(160px, 45vw);
            max-width: 100%;
            word-wrap: break-word;
            overflow: hidden;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px var(--primary-glow);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(160px, 45vw), 1fr));
            gap: min(5px, 1vw);
            justify-items: center;
        }
        
        .system-buttons {
            grid-template-columns: repeat(auto-fit, minmax(min(200px, 40vw), 1fr));
        }

        .action-category {
            margin: min(20px, 3vh) 0;
            padding-top: min(15px, 2vh);
            border-top: 1px solid #444;
        }

        .bonus-details {
            margin-top: min(10px, 1.5vh);
            font-size: var(--font-size-sm);
        }
        
        .bonus-details summary {
            cursor: pointer;
            color: var(--primary-color);
            margin-bottom: min(8px, 1vh);
        }

        .log-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: min(15px, 2vw);
            height: min(400px, 50vh);
            display: flex;
            flex-direction: column;
        }

        .log-header {
            font-size: var(--font-size-lg);
            color: var(--primary-color);
            margin-bottom: min(10px, 1.5vh);
            text-shadow: 0 0 20px var(--primary-glow);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        #log {
            background: var(--bg-dark);
            border-left: 4px solid var(--primary-color);
            padding: min(14px, 2vw) min(18px, 2vw);
            flex: 1;
            border-radius: 0 8px 8px 0;
            font-size: var(--font-size-md);
            line-height: 1.6;
            overflow-y: auto;
            overflow-x: hidden;
            word-wrap: break-word;
            text-align: left;
        }

        /* ==================== ä¿®å¤å¼¹çª—å±…ä¸­é—®é¢˜ ==================== */
        .skill-panel, .artifact-panel, .sect-panel, .relic-panel, .pill-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-dark);
            border: 2px solid;
            border-radius: 15px;
            padding: min(25px, 3vw);
            width: min(650px, 95vw);
            max-width: 95vw;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 0 40px;
            z-index: 3000;
            display: none;
        }
        
        .close-panel-btn {
            position: absolute;
            top: min(10px, 1.5vw);
            right: min(15px, 2vw);
            background: #FF5722;
            border: none;
            color: white;
            border-radius: 50%;
            width: min(30px, 5vw);
            height: min(30px, 5vw);
            cursor: pointer;
            font-size: var(--font-size-md);
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: min(30px, 5vw);
        }

        .save-buttons {
            background: rgba(22, 33, 62, 0.9);
            border: 1px solid #444;
            border-radius: 8px;
            padding: min(12px, 1.5vw);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            margin-top: 15px;
        }

        .save-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .version-info {
            font-size: var(--font-size-sm);
            color: var(--text-dim);
            background: rgba(0,0,0,0.3);
            padding: 5px 10px;
            border-radius: 4px;
            white-space: nowrap;
            font-family: monospace;
        }

        .tribulation-warning {
            color: #FF0000;
            font-weight: bold;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            50% { opacity: 0.5; }
        }

        .talent-positive { color: #4CAF50; }
        .talent-negative { color: #f44336; }
        .talent-neutral { color: #FFC107; }

        .event-positive { color: #4CAF50; font-weight: bold; }
        .event-negative { color: #f44336; font-weight: bold; }
        .event-neutral { color: #FFC107; }

        @media (max-width: 1100px) {
            .game-container {
                width: 98vw;
                padding: 2vw;
            }
            .main-layout {
                flex-direction: column;
            }
            .left-panel {
                flex: 1;
                width: 100%;
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
            .left-panel {
                flex: 1;
                width: 100%;
                max-height: none;
            }
            .button-grid {
                grid-template-columns: 1fr;
            }
            .stat-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .save-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            .skill-panel, .artifact-panel, .sect-panel, .relic-panel {
                width: 98vw;
                height: 98vh;
                max-height: 98vh;
                border-radius: 0;
                top: 0 !important;
                left: 0 !important;
                transform: none !important;
            }
        }

        @media (max-width: 480px) {
            :root {
                --font-size-xs: 10px;
                --font-size-sm: 11px;
                --font-size-md: 13px;
                --font-size-lg: 16px;
                --font-size-xl: 20px;
                --font-age-title: 32px;
            }
            
            .game-container {
                padding: 3vw;
                border-radius: 0;
                max-height: 100vh;
            }
            
            .main-layout {
                gap: 10px;
            }
            
            .left-panel {
                gap: 10px;
            }
            
            .right-panel {
                gap: 10px;
            }
            
            .start-button {
                padding: 4vw 6vw;
                min-width: 90vw;
            }
            
            button {
                padding: 3vw 4vw;
                min-width: 90vw;
            }
            
            .log-container {
                height: min(300px, 40vh);
            }
        }

        .hidden { opacity: 0 !important; pointer-events: none !important; }

        .debug-console {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 150px;
            background: rgba(0,0,0,0.9);
            color: #00ff00;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            overflow-y: auto;
            z-index: 4000;
            display: none;
            border-bottom: 1px solid #333;
        }

        .debug-info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 3000;
            max-width: 300px;
            display: none;
        }

        /* ==================== æ–°å¢ä¸¹è¯é¢æ¿æ ·å¼ ==================== */
        .pill-type-section {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
        }

        .pill-type-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--primary-color);
        }

        .pill-type-cultivation { color: #4CAF50; }
        .pill-type-realm { color: #00BCD4; }

        .pill-item {
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            transition: all 0.3s ease;
        }

        .pill-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 0 10px var(--primary-glow);
        }

        .pill-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .pill-desc {
            font-size: 14px;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .pill-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            font-size: 13px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
        }

        .stat-item span:first-child {
            color: var(--text-dim);
        }

        .stat-item span:last-child {
            font-weight: bold;
        }

        .current-pill-info {
            background: rgba(0, 188, 212, 0.1);
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .current-pill-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .pill-action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .pill-action-buttons button {
            flex: 1;
            min-width: 120px;
        }
        
        .cost-highlight { color: #FFC107; }
        .realm-reward { color: #00FFFF; font-weight: bold; }
        .artifact-name { color: #FFC107; }
        .sect-name { color: #4CAF50; }
        .sect-contribution { color: #00BCD4; }
        .skill-effective { color: #4CAF50; }
        .speed-bonus { color: #00BCD4; }
        .stones { color: #FFC107; }
        .pill-name { color: #00BCD4; }
        .realm-speed { color: #FFC107; }
    </style>
</head>
<body>
    <!-- è°ƒè¯•æ§åˆ¶å° -->
    <div id="debugConsole" class="debug-console"></div>
    
    <!-- è°ƒè¯•ä¿¡æ¯é¢æ¿ -->
    <div id="debugInfo" class="debug-info">
        <div>ç‰ˆæœ¬: v1.5-ä¸¹è¯é‡æ„ç‰ˆ + å¢ƒç•Œé€Ÿåº¦åŠ æˆ</div>
        <div id="loadStatus">çŠ¶æ€: åŠ è½½ä¸­...</div>
        <div id="functionStatus">å‡½æ•°: æœªæ£€æŸ¥</div>
        <!-- ä¿®æ”¹ä¸ºä½¿ç”¨IDè€Œéå†…è”onclick -->
        <button id="forceStartBtn" style="margin-top:5px; padding:5px; font-size:10px; min-width:80px;">å¼ºåˆ¶å¯åŠ¨</button>
    </div>

    <!-- ==================== å°é¢ ==================== -->
    <div class="cover-container" id="coverContainer">
        <div class="cover-title">ä¿®ä»™æ¨¡æ‹Ÿå™¨</div>
        <div class="cover-subtitle">v1.5-ä¸¹è¯é‡æ„ç‰ˆ + å¢ƒç•Œé€Ÿåº¦åŠ æˆ</div>
        <div class="cover-subtitle">ä¸¹é“ç„å¦™ï¼Œç ´å¢ƒé£å‡</div>
        <button class="start-button" id="startBtn">å¼€å§‹æ¸¸æˆ</button>
    </div>

    <!-- ==================== æ¸¸æˆä¸»ç•Œé¢ ==================== -->
    <div class="game-container" id="gameContainer" style="display: none;">
        <!-- ä¸»å¸ƒå±€ï¼šå·¦å³åˆ†æ  -->
        <div class="main-layout">
            <!-- å·¦ä¾§ï¼šå±æ€§é¢æ¿ -->
            <div class="left-panel">
                <!-- ğŸ‘¤ äººç‰©å±æ€§ -->
                <div class="collapsible-panel" id="characterPanel">
                    <div class="panel-header">ğŸ‘¤ äººç‰©å±æ€§</div>
                    <div class="panel-content">
                        <div class="stat-row">
                            <span class="stat-label">å§“å</span>
                            <span class="stat-value" id="playerName">æ— åæ°</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">å¹´é¾„</span>
                            <span class="stat-value" id="playerAge">18å²</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">å¢ƒç•Œ</span>
                            <span class="stat-value realm-info" id="playerRealm">ç‚¼æ°”æœŸ ç¬¬1å±‚</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">å‰©ä½™å¯¿å…ƒ</span>
                            <span class="stat-value time-display" id="playerLifespan">20å¹´0å¤©</span>
                        </div>
                    </div>
                </div>

                <!-- ğŸ’ å¤©èµ‹å¼‚ç¦€ -->
                <div class="collapsible-panel" id="talentPanel">
                    <div class="panel-header">ğŸ’ å¤©èµ‹å¼‚ç¦€</div>
                    <div class="panel-content" id="talentContent">
                        <!-- å¤©èµ‹å†…å®¹åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- ğŸ”¥ ä¿®ç‚¼çŠ¶æ€ -->
                <div class="collapsible-panel" id="cultivationPanel">
                    <div class="panel-header">ğŸ”¥ ä¿®ç‚¼çŠ¶æ€</div>
                    <div class="panel-content">
                        <div class="stat-row">
                            <span class="stat-label">å½“å‰å¢ƒç•Œ</span>
                            <span class="stat-value" id="fullRealm">ç‚¼æ°”æœŸ ç¬¬1å±‚</span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" id="qiBar" style="width: 0%;">
                                <span id="qiProgressText">0%</span>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">ä¿®ä¸ºè¿›åº¦</span>
                            <span class="stat-value">
                                <span id="qi">0</span> / <span id="maxQiDisplay">200</span>
                            </span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">æ€»ä¿®ç‚¼é€Ÿåº¦</span>
                            <span class="stat-value speed-bonus">
                                âš¡ <span id="totalSpeed">1</span> ç‚¹/ç§’
                            </span>
                        </div>
                        <details class="bonus-details" id="bonusDetails">
                            <summary>æŸ¥çœ‹åŠ æˆæ˜ç»†</summary>
                            <div class="stat-row">
                                <span class="stat-label">â”œâ”€ åŸºç¡€ä¿®ç‚¼</span>
                                <span class="stat-value">+<span id="baseSpeed">1</span></span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">â”œâ”€ å¢ƒç•ŒåŠ æˆ</span>
                                <span class="stat-value realm-speed">+<span id="realmSpeedBonus">0</span></span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">â”œâ”€ åŠŸæ³•åŠ æˆ</span>
                                <span class="stat-value skill-effective">+<span id="totalSkillBonus">0</span></span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">â”œâ”€ æ³•å®åŠ æˆ</span>
                                <span class="stat-value">+<span id="artifactBonusDisplay">0</span></span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">â””â”€ å®—é—¨åŠ æˆ</span>
                                <span class="stat-value">+<span id="caveBonusDisplay">0</span></span>
                            </div>
                        </details>
                        <!-- å¤©åŠ«è­¦å‘Š -->
                        <div id="tribulationWarning" class="tribulation-warning" style="display:none; margin-top:10px; text-align:center;">
                            âš¡ å¤©åŠ«å°†è‡³ï¼
                        </div>
                    </div>
                </div>

                <!-- ğŸ’ èµ„æºèµ„äº§ -->
                <div class="collapsible-panel" id="resourcePanel">
                    <div class="panel-header">ğŸ’ èµ„æºèµ„äº§</div>
                    <div class="panel-content">
                        <div class="stat-row">
                            <span class="stat-label">ğŸ’ çµçŸ³</span>
                            <span class="stat-value stones" id="stonesDisplay">50</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">ğŸ’Š ä¿®ä¸ºä¸¹</span>
                            <span class="stat-value" id="cultivationPillsDisplay">0 é¢—</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">ğŸŒŸ å¢ƒç•Œä¸¹</span>
                            <span class="stat-value" id="realmPillsDisplay">0 é¢—</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">å½“å‰ä¸¹è¯</span>
                            <span class="stat-value pill-name" id="currentPillName">ç­‘åŸºä¸¹</span>
                        </div>
                    </div>
                </div>

                <!-- ğŸŒŸ ç‰¹æ®ŠçŠ¶æ€ -->
                <div class="collapsible-panel" id="specialStatusPanel">
                    <div class="panel-header">ğŸŒŸ ç‰¹æ®ŠçŠ¶æ€</div>
                    <div class="panel-content" id="specialStatusContent">
                        <!-- ç‰¹æ®ŠçŠ¶æ€å†…å®¹åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ—¥å¿— + æ“ä½œåŒº -->
            <div class="right-panel">
                <!-- ğŸ“œ æ—¥å¿—åŒºåŸŸ -->
                <div class="log-container">
                    <div class="log-header">ğŸ“œ ä¿®ç‚¼æ—¥å¿—</div>
                    <div id="log">
                        æ¬¢è¿æ¥åˆ°ä¿®ä»™ä¸–ç•Œï¼<br>
                        æç¤ºï¼šç‚¹å‡»å·¦ä¾§é¢æ¿æ ‡é¢˜å¯ä»¥å±•å¼€/æ”¶èµ·
                    </div>
                </div>

                <!-- âš¡ æ“ä½œæŒ‰é’®åŒº -->
                <div class="action-area">
                    <!-- ä¿®ç‚¼æ“ä½œ -->
                    <div class="action-category">
                        <div class="stat-header">âš¡ ä¿®ç‚¼æ“ä½œ</div>
                        <div class="button-grid">
                            <button id="cultivateBtn" class="btn-primary">ğŸ§˜ æ‰“åä¿®ç‚¼</button>
                            <button id="autoCultivateBtn" class="btn-secondary">ğŸ¤– å¼€å¯è‡ªåŠ¨ä¿®ç‚¼</button>
                            <button id="upgradeBtn" class="btn-secondary">ğŸ“ˆ æå‡èµ„è´¨</button>
                            <button id="breakthroughBtn" style="display:none;">ğŸ”¥ å°è¯•çªç ´</button>
                        </div>
                        <div id="successRateContainer" style="margin-top:12px; text-align:center; display:none;">
                            <span class="stat-label">çªç ´æˆåŠŸç‡: </span>
                            <span class="success-rate" id="successRate">0%</span>
                            <span id="pillBonus"></span>
                        </div>
                    </div>

                    <!-- ğŸ’Š ä¸¹è¯æ“ä½œ -->
                    <div class="action-category">
                        <div class="stat-header">ğŸ’Š ä¸¹è¯ç³»ç»Ÿ</div>
                        <div class="button-grid">
                            <button id="makePillBtn" class="btn-primary">âš—ï¸ ç‚¼åˆ¶ä¸¹è¯</button>
                            <button id="useCultivationPillBtn" class="btn-secondary" style="display:none;">ğŸ’Š ä½¿ç”¨ä¿®ä¸ºä¸¹</button>
                            <button id="useRealmPillBtn" class="btn-secondary" style="display:none;">ğŸŒŸ ä½¿ç”¨å¢ƒç•Œä¸¹</button>
                            <button id="pillPanelBtn" class="system-btn">ğŸ“œ ä¸¹è¯è¯¦æƒ…</button>
                        </div>
                    </div>

                    <!-- ğŸ® è¾…åŠ©ç³»ç»Ÿ -->
                    <div class="action-category">
                        <div class="stat-header">ğŸ® è¾…åŠ©ç³»ç»Ÿ</div>
                        <div class="button-grid system-buttons">
                            <button id="skillPanelBtn" class="system-btn skills">
                                ğŸ“œ åŠŸæ³•ç³»ç»Ÿ
                                <small>å·²å­¦: <span id="skillCount">0</span>æœ¬</small>
                            </button>
                            <button id="artifactPanelBtn" class="system-btn artifacts">
                                ğŸ—¡ï¸ æ³•å®ç³»ç»Ÿ
                                <small id="artifactStatus">æœªè£…å¤‡</small>
                            </button>
                            <button id="sectPanelBtn" class="system-btn sect">
                                ğŸ›ï¸ å®—é—¨ç³»ç»Ÿ
                                <small id="sectStatus">æœªåŠ å…¥</small>
                            </button>
                            <button id="relicPanelBtn" class="system-btn relics">
                                ğŸ›ï¸ æ¢ç´¢é—è¿¹
                                <small>å¯»æ‰¾å®ç‰©</small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨ï¼šå­˜æ¡£æŒ‰é’® + ç‰ˆæœ¬ä¿¡æ¯ -->
        <div class="save-buttons">
            <div class="save-actions">
                <button id="saveBtn">ğŸ’¾ ä¿å­˜è¿›åº¦</button>
                <button id="loadBtn">ğŸ“‚ è¯»å–è¿›åº¦</button>
                <span id="saveStatus" style="margin-left: 15px; font-size: 14px;"></span>
            </div>
            <div class="version-info">
                ç‰ˆæœ¬: v1.5-ä¸¹è¯é‡æ„ç‰ˆ + å¢ƒç•Œé€Ÿåº¦åŠ æˆ
            </div>
        </div>

        <!-- å¼¹çª—é¢æ¿ -->
        <div id="skillPanel" class="skill-panel" style="display:none; z-index:3001;">
            <button class="close-panel-btn" onclick="GameUI.toggleSkillPanel()">Ã—</button>
            <h2>ğŸ“œ åŠŸæ³•ç³»ç»Ÿ</h2>
            <div id="skillPanelContent">åŠ è½½ä¸­...</div>
        </div>
        <div id="artifactPanel" class="artifact-panel" style="display:none; z-index:3001;">
            <button class="close-panel-btn" onclick="GameUI.toggleArtifactPanel()">Ã—</button>
            <h2>ğŸ—¡ï¸ æ³•å®ç³»ç»Ÿ</h2>
            <div id="artifactPanelContent">åŠ è½½ä¸­...</div>
        </div>
        <div id="sectPanel" class="sect-panel" style="display:none; z-index:3001;">
            <button class="close-panel-btn" onclick="GameUI.toggleSectPanel()">Ã—</button>
            <h2>ğŸ›ï¸ å®—é—¨ç³»ç»Ÿ</h2>
            <div id="sectPanelContent">åŠ è½½ä¸­...</div>
        </div>
        <div id="relicPanel" class="relic-panel" style="display:none; z-index:3001;">
            <button class="close-panel-btn" onclick="GameUI.toggleRelicPanel()">Ã—</button>
            <h2>ğŸ›ï¸ æ¢ç´¢é—è¿¹</h2>
            <div id="relicPanelContent">åŠ è½½ä¸­...</div>
        </div>
        
        <!-- ä¸¹è¯è¯¦æƒ…é¢æ¿ -->
        <div id="pillPanel" class="pill-panel" style="display:none; z-index:3001; border-color: #00BCD4;">
            <button class="close-panel-btn" onclick="GameUI.togglePillPanel()">Ã—</button>
            <h2>ğŸ’Š ä¸¹è¯ç³»ç»Ÿè¯¦æƒ…</h2>
            <div id="pillPanelContent">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <script>
        // ==================== å…¨å±€é”™è¯¯å¤„ç† ==================== 
        window.addEventListener('error', function(e) {
            console.error('ã€å…¨å±€é”™è¯¯æ•è·ã€‘', e.error);
            alert('æ¸¸æˆå‡ºé”™: ' + e.error.message + '\nè¯·æŒ‰F12æŸ¥çœ‹æ§åˆ¶å°');
        });

        // ==================== è°ƒè¯•ç³»ç»Ÿ ==================== 
        window.DEBUG_MODE = true;
        window.version = "v1.5-ä¸¹è¯é‡æ„ç‰ˆ + å¢ƒç•Œé€Ÿåº¦åŠ æˆ";
        
        window.debugLog = function(...args) {
            if (window.DEBUG_MODE) {
                console.log('[DEBUG]', ...args);
                const debugConsole = document.getElementById('debugConsole');
                if (debugConsole) {
                    const message = args.map(arg => 
                        typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
                    ).join(' ');
                    debugConsole.innerHTML += message + '<br>';
                    debugConsole.scrollTop = debugConsole.scrollHeight;
                }
            }
        };
        
        window.toggleDebug = function() {
            window.DEBUG_MODE = !window.DEBUG_MODE;
            const debugConsole = document.getElementById('debugConsole');
            const debugInfo = document.getElementById('debugInfo');
            if (debugConsole) debugConsole.style.display = window.DEBUG_MODE ? 'block' : 'none';
            if (debugInfo) debugInfo.style.display = window.DEBUG_MODE ? 'block' : 'none';
            console.log('è°ƒè¯•æ¨¡å¼:', window.DEBUG_MODE ? 'å¼€å¯' : 'å…³é—­');
        };

        // ==================== å¼ºåˆ¶å¯åŠ¨å‡½æ•° ==================== 
        window.forceStart = function() {
            console.log("ã€å¼ºåˆ¶å¯åŠ¨ã€‘è¢«è°ƒç”¨");
            if (typeof startGame === 'function') {
                startGame();
            } else {
                alert('startGame å‡½æ•°æœªå®šä¹‰ï¼è¯·æŸ¥çœ‹æ§åˆ¶å°');
            }
        };

        // ==================== éªŒè¯å‡½æ•°å®šä¹‰ ==================== 
        window.checkFunctions = function() {
            const functions = {
                'startGame': typeof startGame,
                'GameUI': typeof GameUI,
                'GameActions': typeof GameActions,
                'GameCalculator': typeof GameCalculator,
                'GameLoop': typeof GameLoop,
                'forceStart': typeof forceStart
            };
            console.log("å‡½æ•°çŠ¶æ€æ£€æŸ¥:", functions);
            const statusDiv = document.getElementById('functionStatus');
            if (statusDiv) {
                statusDiv.textContent = 'å‡½æ•°: ' + (functions.startGame === 'function' ? 'æ­£å¸¸' : 'å¼‚å¸¸');
            }
            return functions;
        };

        // ==================== å®šä¹‰æ ¸å¿ƒå¯¹è±¡ ==================== 
        console.log("========== æ¸¸æˆè„šæœ¬å¼€å§‹åŠ è½½ ==========");
        
        window.GameState = {
            player: null,
            skillSystem: null,
            artifactSystem: null,
            sectSystem: null,
            talentSystem: null,
            gameLoop: null,
            autoCultivating: false,
            autoCultivateLogTimer: 0,
            pillSystem: null,
            gameStarted: false
        };

        // ==================== ä¸¹è¯é…ç½® ==================== 
        window.GameConfig = {
            // å¢ƒç•Œç³»ç»Ÿï¼ˆæ–°å¢speedBonusï¼šæ¯ä¸ªå¢ƒç•Œçš„ä¿®ç‚¼é€Ÿåº¦åŠ æˆï¼‰
            realmSystem: [
                { name: "ç‚¼æ°”æœŸ", stages: ["ç¬¬1å±‚", "ç¬¬2å±‚", "ç¬¬3å±‚", "ç¬¬4å±‚", "ç¬¬5å±‚", "ç¬¬6å±‚", "ç¬¬7å±‚", "ç¬¬8å±‚", "ç¬¬9å±‚", "åœ†æ»¡"], baseQi: 200, qiMultiplier: 1.5, speedBonus: 0 },
                { name: "ç­‘åŸºæœŸ", stages: ["åˆæœŸ", "ä¸­æœŸ", "åæœŸ", "åœ†æ»¡"], baseQi: 1000, qiMultiplier: 2, speedBonus: 2 },
                { name: "é‡‘ä¸¹æœŸ", stages: ["åˆæœŸ", "ä¸­æœŸ", "åæœŸ", "åœ†æ»¡"], baseQi: 5000, qiMultiplier: 2.5, speedBonus: 5 },
                { name: "å…ƒå©´æœŸ", stages: ["åˆæœŸ", "ä¸­æœŸ", "åæœŸ", "åœ†æ»¡"], baseQi: 20000, qiMultiplier: 3, speedBonus: 10 },
                { name: "åŒ–ç¥æœŸ", stages: ["åˆæœŸ", "ä¸­æœŸ", "åæœŸ", "åœ†æ»¡"], baseQi: 50000, qiMultiplier: 3.5, speedBonus: 20 }
            ],
            
            // ä¿®ä¸ºä¸¹é…ç½®
            cultivationPills: [
                { id: "qi_gathering", name: "èšæ°”ä¸¹", power: 50, cost: 20, desc: "ç›´æ¥å¢åŠ 50ç‚¹ä¿®ä¸º", minRealm: 0 },
                { id: "spirit_gathering", name: "èšçµä¸¹", power: 150, cost: 50, desc: "ç›´æ¥å¢åŠ 150ç‚¹ä¿®ä¸º", minRealm: 1 },
                { id: "spirit_condensing", name: "å‡å…ƒä¸¹", power: 500, cost: 150, desc: "ç›´æ¥å¢åŠ 500ç‚¹ä¿®ä¸º", minRealm: 2 },
                { id: "yuan_condensing", name: "å‡å©´ä¸¹", power: 2000, cost: 400, desc: "ç›´æ¥å¢åŠ 2000ç‚¹ä¿®ä¸º", minRealm: 3 }
            ],
            
            // å¢ƒç•Œä¸¹é…ç½®ï¼ˆæ¯ä¸ªå¢ƒç•Œå›ºå®šï¼‰
            realmPills: [
                { id: "foundation", name: "ç­‘åŸºä¸¹", power: 15, cost: 30, desc: "ç­‘åŸºå¿…å¤‡ï¼Œæå‡çªç ´æˆåŠŸç‡15%", minRealm: 0, maxRealm: 1 },
                { id: "golden_core", name: "é‡‘å…ƒä¸¹", power: 20, cost: 80, desc: "ç»“ä¸¹å¿…å¤‡ï¼Œæå‡çªç ´æˆåŠŸç‡20%", minRealm: 1, maxRealm: 2 },
                { id: "yuan_baby", name: "åŒ–å©´ä¸¹", power: 25, cost: 200, desc: "å‡å©´å¿…å¤‡ï¼Œæå‡çªç ´æˆåŠŸç‡25%", minRealm: 2, maxRealm: 3 },
                { id: "spirit_intent", name: "ç¥æ„ä¸¹", power: 30, cost: 500, desc: "åŒ–ç¥å¿…å¤‡ï¼Œæå‡çªç ´æˆåŠŸç‡30%", minRealm: 3, maxRealm: 4 }
            ],
            
            // ä¸¹è¯å¯¹åº”å…³ç³»ï¼ˆæ¯ä¸ªå¢ƒç•Œå¯¹åº”å›ºå®šçš„ä¿®ä¸ºä¸¹å’Œå¢ƒç•Œä¸¹ï¼‰
            pillMapping: {
                0: { cultivationPillId: "qi_gathering", realmPillId: "foundation", realmPillName: "ç­‘åŸºä¸¹" },
                1: { cultivationPillId: "spirit_gathering", realmPillId: "golden_core", realmPillName: "é‡‘å…ƒä¸¹" },
                2: { cultivationPillId: "spirit_condensing", realmPillId: "yuan_baby", realmPillName: "åŒ–å©´ä¸¹" },
                3: { cultivationPillId: "yuan_condensing", realmPillId: "spirit_intent", realmPillName: "ç¥æ„ä¸¹" },
                4: { cultivationPillId: "yuan_condensing", realmPillId: "spirit_intent", realmPillName: "ç¥æ„ä¸¹" }
            },
            
            skills: [
                { id: "basic_cultivation", name: "åŸºç¡€åçº³æ³•", tier: "common", bonus: 1, desc: "æœ€åŸºç¡€çš„ä¿®ç‚¼æ³•é—¨", realmReq: 0, cost: 50 },
                { id: "spirit_gathering", name: "èšçµè¯€", tier: "common", bonus: 2, desc: "åŠ å¿«çµæ°”èšé›†", realmReq: 0, cost: 50 },
                { id: "five_elements", name: "äº”è¡Œç‚¼æ°”æœ¯", tier: "uncommon", bonus: 4, desc: "äº”è¡Œç›¸ç”Ÿï¼Œä¿®ç‚¼åŠ é€Ÿ", realmReq: 0, cost: 150 },
                { id: "heavenly_circulation", name: "å‘¨å¤©æ¬è¿æ³•", tier: "uncommon", bonus: 6, desc: "è¿è½¬å‘¨å¤©ï¼Œæ•ˆç‡æå‡", realmReq: 1, cost: 150 },
                { id: "golden_core_formation", name: "é‡‘ä¸¹å‡èšæœ¯", tier: "rare", bonus: 10, desc: "é‡‘ä¸¹æœŸä¸“ç”¨ç§˜æ³•", realmReq: 1, cost: 400 }
            ],
            
            artifacts: [
                { id: "spirit_sword", name: "çµå‰‘", tier: "common", bonus: 2, desc: "æ™®é€šé£å‰‘", cost: 500, realmReq: 0 },
                { id: "jade_pendant", name: "èšçµç‰ä½©", tier: "common", bonus: 3, desc: "èšçµå…»æ°”", cost: 500, realmReq: 0 },
                { id: "bronze_mirror", name: "é’é“œå¤é•œ", tier: "uncommon", bonus: 5, desc: "å¤ä¿®å£«é—ç•™", cost: 500, realmReq: 1 }
            ],
            
            sects: [
                { id: "small_sect", name: "å°é—¨æ´¾", tier: "common", joinCost: 0, desc: "å°é—¨æ´¾ï¼Œæ— é—¨æ§›", realmReq: 0, benefit: { stones: 0, speed: 0 } },
                { id: "spirit_sect", name: "çµäº‘å®—", tier: "uncommon", joinCost: 100, desc: "ä¸­ç­‰å®—é—¨ï¼Œéœ€100çµçŸ³", realmReq: 1, benefit: { stones: 0, speed: 1 } },
                { id: "golden_sect", name: "é‡‘ä¸¹é—¨", tier: "rare", joinCost: 300, desc: "é‡‘ä¸¹å¤§å®—ï¼Œéœ€300çµçŸ³", realmReq: 2, benefit: { stones: 0, speed: 2 } }
            ],
            
            relics: [
                { id: "ancient_cave", name: "å¤ä¿®æ´åºœ", cost: 5, minReward: 20, maxReward: 50, desc: "æ™®é€šä¿®å£«é—ç•™" },
                { id: "secret_realm", name: "ç§˜å¢ƒ", cost: 10, minReward: 50, maxReward: 150, desc: "ç¥ç§˜ç©ºé—´" },
                { id: "ancient_battlefield", name: "ä¸Šå¤æˆ˜åœº", cost: 20, minReward: 150, maxReward: 400, desc: "å±é™©ä½†å®ç‰©ä¸°å¯Œ" }
            ],
            
            talents: [
                { id: "prodigy", name: "ä¿®ç‚¼å¥‡æ‰", type: "positive", desc: "åŸºç¡€ä¿®ç‚¼é€Ÿåº¦+2", effect: function(p) { p.baseSpeed += 2; } },
                { id: "wealthy", name: "å¯Œå®¶å­å¼Ÿ", type: "positive", desc: "åˆå§‹çµçŸ³+300", effect: function(p) { p.stones += 300; } },
                { id: "long_life", name: "é•¿å‘½ç™¾å²", type: "positive", desc: "åˆå§‹å¯¿å‘½+5å¹´", effect: function(p) { p.maxLifespan += 5 * 365; p.lifespan += 5 * 365; } },
                { id: "lucky", name: "æ°”è¿ä¹‹å­", type: "positive", desc: "çªç ´æˆåŠŸç‡+10%", effect: function(p) { p.breakthroughBonus = (p.breakthroughBonus || 0) + 10; } },
                { id: "spirit_body", name: "çµä½“", type: "positive", desc: "ä¿®ç‚¼é€Ÿåº¦+1", effect: function(p) { p.baseSpeed += 1; } },
                { id: "immortal_bone", name: "ä»™éª¨", type: "positive", desc: "æ‰€æœ‰ä¿®ç‚¼æ•ˆç‡+20%", effect: function(p) { p.globalBonus = (p.globalBonus || 1) + 0.2; } },
                { id: "phoenix_blood", name: "å‡¤å‡°è¡€è„‰", type: "positive", desc: "çªç ´å¤±è´¥æ—¶ä¿®ä¸ºæŸå¤±å‡åŠ", effect: function(p) { p.phoenixBlessing = true; } },
                { id: "lucky_star", name: "ç¦ç¼˜æ·±åš", type: "positive", desc: "å¥‡é‡è§¦å‘æ¦‚ç‡+200%ï¼Œå¥‡é‡å“è´¨æ›´å¥½", effect: function(p) { p.luck = (p.luck || 1) * 3; } },
                { id: "poor_root", name: "èµ„è´¨å¹³åº¸", type: "negative", desc: "åŸºç¡€ä¿®ç‚¼é€Ÿåº¦-0.5", effect: function(p) { p.baseSpeed -= 0.5; } },
                { id: "poor", name: "å®¶å¾’å››å£", type: "negative", desc: "åˆå§‹çµçŸ³-30", effect: function(p) { p.stones -= 30; } },
                { id: "sickly", name: "ä½“å¼±å¤šç—…", type: "negative", desc: "åˆå§‹å¯¿å‘½-3å¹´", effect: function(p) { p.maxLifespan -= 3 * 365; p.lifespan -= 3 * 365; } },
                { id: "unlucky", name: "éœ‰è¿ç¼ èº«", type: "negative", desc: "çªç ´æˆåŠŸç‡-5%", effect: function(p) { p.breakthroughBonus = (p.breakthroughBonus || 0) - 5; } },
                { id: "waste_body", name: "åºŸä½“", type: "negative", desc: "ä¿®ç‚¼é€Ÿåº¦-1", effect: function(p) { p.baseSpeed -= 1; } },
                { id: "thief", name: "ç›—è´¼", type: "positive", desc: "æ¢ç´¢é—è¿¹è·å¾—é¢å¤–çµçŸ³", effect: function(p) { p.thiefBonus = true; } },
                { id: "balanced", name: "ä¸­åº¸ä¹‹é“", type: "neutral", desc: "æ‰€æœ‰å±æ€§+5%ï¼Œæ‰€æœ‰æ¶ˆè€—+5%", effect: function(p) { p.baseSpeed *= 1.05; p.globalBonus = (p.globalBonus || 1) + 0.05; p.priceIncrease = (p.priceIncrease || 1) + 0.05; } },
                { id: "gambler", name: "èµŒå¾’", type: "neutral", desc: "çªç ´æˆåŠŸç‡Â±15%éšæœº", effect: function(p) { p.breakthroughRandom = true; } },
                { id: "ascetic", name: "è‹¦ä¿®è€…", type: "neutral", desc: "æ— æ³•ä½¿ç”¨ä¸¹è¯ï¼Œä½†åŸºç¡€ä¿®ç‚¼é€Ÿåº¦+3", effect: function(p) { p.noPills = true; p.baseSpeed += 3; } }
            ],
            
            randomEvents: [
                { name: "å‘ç°çµçŸ³çŸ¿è„‰", type: "positive", effect: function(p) { const reward = Math.floor(100 * (p.moneyBonus || 1) * (p.eventQuality || 1)); p.stones += reward; GameUI.log(`ğŸ² <span class="event-positive">ã€å¥‡é‡ã€‘å‘ç°çµçŸ³çŸ¿è„‰ï¼</span> +${reward}çµçŸ³`); } },
                { name: "å¿ƒé­”å…¥ä¾µ", type: "negative", effect: function(p) { const loss = Math.floor(p.qi * 0.1 * (p.eventQuality || 1)); p.qi = Math.max(0, p.qi - loss); GameUI.log(`ğŸ² <span class="event-negative">ã€å„è¿ã€‘å¿ƒé­”å…¥ä¾µï¼</span> ä¿®ä¸ºæŸå¤±${loss}`); } },
                { name: "ä¸€æœé¡¿æ‚Ÿ", type: "positive", effect: function(p) { const bonus = Math.floor(5 * (p.eventQuality || 1)); p.baseSpeed += bonus; GameUI.log(`ğŸ² <span class="event-positive">ã€å¥‡é‡ã€‘ä¸€æœé¡¿æ‚Ÿï¼</span> ä¿®ç‚¼é€Ÿåº¦+${bonus}`); } },
                { name: "å‘ç°å¤©æåœ°å®", type: "positive", effect: function(p) { const maxQi = GameCalculator.getMaxQi(p.realmIndex, p.stageIndex); const boost = Math.floor(maxQi * 0.05 * (p.eventQuality || 1)); p.qi = Math.min(p.qi + boost, maxQi); GameUI.log(`ğŸ² <span class="event-positive">ã€å¥‡é‡ã€‘å‘ç°å¤©æåœ°å®ï¼</span> ä¿®ä¸ºæå‡${boost}`); } },
                { name: "è¢«åŠ«ä¿®ç›¯ä¸Š", type: "negative", effect: function(p) { const stoneLoss = Math.floor(p.stones * 0.2 * (p.eventQuality || 1)); const lostStones = Math.min(stoneLoss, Math.floor(p.stones * 0.5)); p.stones -= lostStones; if (Math.random() < 0.5) { const qiLoss = Math.floor(p.qi * 0.05); p.qi = Math.max(0, p.qi - qiLoss); GameUI.log(`ğŸ² <span class="event-negative">ã€å„è¿ã€‘è¢«åŠ«ä¿®è¢­å‡»ï¼</span> æŸå¤±${lostStones}çµçŸ³ï¼Œä¿®ä¸ºæŸå¤±${qiLoss}`); } else { GameUI.log(`ğŸ² <span class="event-neutral">ã€å„è¿ã€‘è¢«åŠ«ä¿®ç›¯ä¸Šï¼</span> æŸå¤±${lostStones}çµçŸ³ï¼Œä½†æˆåŠŸé€ƒè„±`); } } },
                { name: "é‡åˆ°ç¥ç§˜å•†äºº", type: "neutral", effect: function(p) { 
                    const currentPillIds = GameCalculator.getCurrentPillIds(p.realmIndex);
                    const realmPill = GameCalculator.getRealmPill(currentPillIds.realmPillId);
                    if (Math.random() < 0.5) {
                        p.pillCost = Math.max(10, Math.floor(p.pillCost * 0.8));
                        GameUI.log(`ğŸ² <span class="event-positive">ã€å¥‡é‡ã€‘é‡åˆ°ç¥ç§˜å•†äººï¼</span> ${realmPill.name}æˆæœ¬é™è‡³${p.pillCost}çµçŸ³`);
                    } else {
                        p.pillCost = Math.floor(p.pillCost * 1.2);
                        GameUI.log(`ğŸ² <span class="event-neutral">é‡åˆ°å¥¸å•†ï¼</span> ${realmPill.name}æˆæœ¬æ¶¨è‡³${p.pillCost}çµçŸ³`);
                    }
                }},
                { name: "æ³•å®å…±é¸£", type: "positive", effect: function(p) { 
                    if (GameState.artifactSystem.owned) { 
                        const artifact = GameState.artifactSystem.owned; 
                        GameUI.log(`ğŸ² <span class="event-positive">ã€æ³•å®å¥‡é‡ã€‘${artifact.name}äº§ç”Ÿå…±é¸£ï¼</span> ä¿®å¤éƒ¨åˆ†é€€åŒ–æ•ˆæœ`); 
                        p.artifactResonance = 30; 
                    } else { 
                        GameUI.log(`ğŸ² <span class="event-neutral">æ„Ÿå—åˆ°ç¥ç§˜æ³•å®æ°”æ¯ï¼Œä½†æœªèƒ½è·å¾—</span>`); 
                    } 
                }},
                { name: "å¯¿å…ƒæ³¢åŠ¨", type: "neutral", effect: function(p) { const change = Math.floor((Math.random() - 0.5) * 30 * (p.eventQuality || 1)); p.lifespan = Math.max(30, p.lifespan + change); if (change > 0) { GameUI.log(`ğŸ² <span class="event-positive">ã€å¥‡é‡ã€‘æœç”¨å»¶å¯¿çµæœï¼</span> å¯¿å…ƒå¢åŠ ${change}å¤©`); } else { GameUI.log(`ğŸ² <span class="event-negative">ã€å„è¿ã€‘å¯¿å…ƒæ„å¤–æµå¤±ï¼</span> å‡å°‘${Math.abs(change)}å¤©`); } } }
            ]
        };

        window.GameCalculator = {
            getMaxQi: function(realmIndex, stageIndex) {
                const realm = GameConfig.realmSystem[realmIndex];
                return Math.floor(realm.baseQi * Math.pow(realm.qiMultiplier, stageIndex));
            },
            
            // æ–°å¢ï¼šè®¡ç®—å¢ƒç•Œé€Ÿåº¦åŠ æˆ
            getRealmSpeedBonus: function(realmIndex) {
                const realm = GameConfig.realmSystem[realmIndex];
                return realm.speedBonus || 0;
            },
            
            getUpgradeCost: function(player) { return 10 + player.realmIndex * 20 + player.stageIndex * 5; },
            calculateBreakthroughRate: function(player) { 
                const baseRate = Math.max(5, 100 - player.stageIndex * 10); 
                const pillBonus = player.usedRealmPill ? Math.floor(GameCalculator.getRealmPill(player.currentRealmPillId).power * (player.pillPowerMultiplier || 1)) : 0; 
                const talentBonus = player.breakthroughBonus || 0; 
                const difficulty = player.breakthroughDifficulty || 1; 
                const randomBonus = player.breakthroughRandom ? Math.floor(Math.random() * 31) - 15 : 0; 
                const finalRate = Math.floor((baseRate + pillBonus + talentBonus + randomBonus) * difficulty); 
                return Math.max(5, Math.min(95, finalRate));
            },
            calculateSkillBonus: function(skillSystem, player) { 
                const baseBonus = skillSystem.learned.reduce(function(sum, skill) { return sum + skill.bonus; }, 0); 
                const talentMultiplier = player.skillBoost || 1; 
                const talentPenalty = player.skillPenalty || 1; 
                const effectPenalty = player.skillEffectPenalty || 1; 
                return Math.floor(baseBonus * talentMultiplier * talentPenalty * effectPenalty); 
            },
            calculateArtifactBonus: function(artifactSystem, player) { 
                if (!artifactSystem.owned) return 0; 
                const degradation = Math.max(0.3, 1 - (player.realmIndex - artifactSystem.owned.realmReq) * 0.2); 
                const talentBoost = player.artifactBoost || 1; 
                const talentPenalty = player.artifactPenalty || 1; 
                return Math.floor(artifactSystem.owned.bonus * degradation * talentBoost * talentPenalty); 
            },
            getSectBonus: function(sectSystem, type, player) { 
                if (!sectSystem || !sectSystem.owned) return 0; 
                const baseBonus = sectSystem.owned.benefit[type] || 0; 
                const talentBoost = player.sectBonusBoost || 1; 
                return baseBonus * talentBoost; 
            },
            getCurrentPillIds: function(realmIndex) {
                return GameConfig.pillMapping[realmIndex] || GameConfig.pillMapping[0];
            },
            getCultivationPill: function(pillId) {
                return GameConfig.cultivationPills.find(p => p.id === pillId);
            },
            getRealmPill: function(pillId) {
                return GameConfig.realmPills.find(p => p.id === pillId);
            }
        };

        function formatLifespan(days) { 
            const years = Math.floor(days / 365); 
            const remainingDays = Math.floor(days % 365); 
            return years + "å¹´" + remainingDays + "å¤©"; 
        }
        
        function addStageLifespanReward(player, realmIndex) { 
            let stageReward = 0; 
            switch(realmIndex) { 
                case 0: stageReward = Math.floor(Math.random() * 3) + 1; break; 
                case 1: stageReward = 25; break; 
                case 2: stageReward = 30; break; 
                case 3: stageReward = 40; break; 
                case 4: stageReward = Math.floor(Math.random() * 51) + 50; break; 
            } 
            if (stageReward > 0) { 
                player.maxLifespan += stageReward * 365; 
                player.lifespan += stageReward * 365; 
                GameUI.log('<span class="realm-reward">âœ¨ å¢ƒç•Œæå‡ï¼å¯¿å…ƒ+' + stageReward + 'å¹´</span>'); 
            } 
        }

        window.GameUI = {
            isUIInitialized: false,
            
            initStableUI: function() {
                if (this.isUIInitialized) {
                    console.log("ã€UIã€‘å·²ç»åˆå§‹åŒ–å®Œæˆï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–");
                    return;
                }
                
                console.log("ã€UIã€‘å¼€å§‹åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨...");
                document.querySelectorAll('.panel-header').forEach(header => {
                    header.addEventListener('click', function() {
                        const panel = this.parentElement;
                        panel.classList.toggle('collapsed');
                    });
                });
                
                const buttons = [
                    { id: "cultivateBtn", action: function() { GameActions.cultivate(); } },
                    { id: "autoCultivateBtn", action: function() { GameActions.toggleAutoCultivate(); } },
                    { id: "upgradeBtn", action: function() { GameActions.upgrade(); } },
                    { id: "breakthroughBtn", action: function() { GameActions.attemptBreakthrough(); } },
                    { id: "makePillBtn", action: function() { GameActions.makePill(); } },
                    { id: "useCultivationPillBtn", action: function() { GameActions.useCultivationPill(); } },
                    { id: "useRealmPillBtn", action: function() { GameActions.useRealmPill(); } },
                    { id: "pillPanelBtn", action: function() { GameUI.togglePillPanel(); } },
                    { id: "skillPanelBtn", action: function() { GameUI.toggleSkillPanel(); } },
                    { id: "artifactPanelBtn", action: function() { GameUI.toggleArtifactPanel(); } },
                    { id: "sectPanelBtn", action: function() { GameUI.toggleSectPanel(); } },
                    { id: "relicPanelBtn", action: function() { GameUI.toggleRelicPanel(); } }
                ];
                
                buttons.forEach(btn => {
                    const element = document.getElementById(btn.id);
                    if (element) {
                        element.onclick = null;
                        element.addEventListener("click", function() { 
                            console.log(`ã€æŒ‰é’®ã€‘ç‚¹å‡»ï¼š${btn.id}`);
                            btn.action(); 
                        }, { once: false });
                    } else {
                        console.error(`ã€é”™è¯¯ã€‘æ‰¾ä¸åˆ°æŒ‰é’®ï¼š${btn.id}`);
                    }
                });
                
                const saveBtn = document.getElementById('saveBtn');
                const loadBtn = document.getElementById('loadBtn');
                if (saveBtn) {
                    saveBtn.onclick = null;
                    saveBtn.addEventListener('click', function() { GameActions.saveGame(); });
                }
                if (loadBtn) {
                    loadBtn.onclick = null;
                    loadBtn.addEventListener('click', function() { GameActions.loadGame(); });
                }
                
                this.isUIInitialized = true;
                console.log("ã€UIã€‘äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆï¼");
            },
            
            update: function() {
                const p = GameState.player;
                if (!p) return;
                
                const maxQi = GameCalculator.getMaxQi(p.realmIndex, p.stageIndex);
                const qiProgress = Math.min(100, Math.floor((p.qi / maxQi) * 100));
                
                // è®¡ç®—å„é¡¹åŠ æˆï¼ˆæ–°å¢å¢ƒç•Œé€Ÿåº¦åŠ æˆï¼‰
                const realmSpeedBonus = GameCalculator.getRealmSpeedBonus(p.realmIndex);
                const skillBonus = GameCalculator.calculateSkillBonus(GameState.skillSystem, p);
                const artifactBonus = GameCalculator.calculateArtifactBonus(GameState.artifactSystem, p);
                const sectBonus = GameCalculator.getSectBonus(GameState.sectSystem, "speed", p);
                
                let totalSpeed = ((p.baseSpeed || 1) + realmSpeedBonus + skillBonus + artifactBonus + sectBonus) * (p.globalBonus || 1) * (p.qiGainBonus || 1);
                if (p.artifactResonance > 0) totalSpeed *= 1.5;
                if (p.manualCultivateBonus) totalSpeed *= p.manualCultivateBonus;
                if (p.manualCultivatePenalty) totalSpeed *= p.manualCultivatePenalty;
                
                const yearsConsumed = Math.floor((p.maxLifespan - p.lifespan) / 365);
                const displayAge = p.initialAge + yearsConsumed;
                
                const el = function(id) { return document.getElementById(id); };
                
                const elements = { 
                    playerName: el("playerName"), 
                    playerAge: el("playerAge"), 
                    playerRealm: el("playerRealm"), 
                    playerLifespan: el("playerLifespan"), 
                    fullRealm: el("fullRealm"), 
                    qi: el("qi"), 
                    maxQiDisplay: el("maxQiDisplay"), 
                    totalSpeed: el("totalSpeed"), 
                    baseSpeed: el("baseSpeed"),
                    realmSpeedBonus: el("realmSpeedBonus"),
                    totalSkillBonus: el("totalSkillBonus"), 
                    artifactBonusDisplay: el("artifactBonusDisplay"), 
                    caveBonusDisplay: el("caveBonusDisplay"), 
                    stonesDisplay: el("stonesDisplay"), 
                    currentPillName: el("currentPillName"), 
                    qiBar: el("qiBar"), 
                    qiProgressText: el("qiProgressText"), 
                    skillCount: el("skillCount"), 
                    artifactStatus: el("artifactStatus"), 
                    sectStatus: el("sectStatus"), 
                    tribulationWarning: el("tribulationWarning"),
                    cultivationPillsDisplay: el("cultivationPillsDisplay"),
                    realmPillsDisplay: el("realmPillsDisplay")
                };
                
                if (elements.playerName) elements.playerName.textContent = p.name || "æ— åæ°";
                if (elements.playerAge) elements.playerAge.textContent = displayAge + "å²";
                if (elements.playerRealm) elements.playerRealm.textContent = GameConfig.realmSystem[p.realmIndex].name + " " + GameConfig.realmSystem[p.realmIndex].stages[p.stageIndex];
                if (elements.playerLifespan) elements.playerLifespan.textContent = formatLifespan(p.lifespan);
                if (elements.fullRealm) elements.fullRealm.textContent = GameConfig.realmSystem[p.realmIndex].name + " " + GameConfig.realmSystem[p.realmIndex].stages[p.stageIndex];
                if (elements.qi) elements.qi.textContent = Math.floor(p.qi);
                if (elements.maxQiDisplay) elements.maxQiDisplay.textContent = maxQi.toLocaleString();
                if (elements.totalSpeed) elements.totalSpeed.textContent = totalSpeed.toFixed(1);
                if (elements.baseSpeed) elements.baseSpeed.textContent = (p.baseSpeed || 1).toFixed(1);
                if (elements.realmSpeedBonus) elements.realmSpeedBonus.textContent = realmSpeedBonus;
                if (elements.totalSkillBonus) elements.totalSkillBonus.textContent = skillBonus;
                if (elements.artifactBonusDisplay) elements.artifactBonusDisplay.textContent = artifactBonus;
                if (elements.caveBonusDisplay) elements.caveBonusDisplay.textContent = sectBonus;
                if (elements.stonesDisplay) elements.stonesDisplay.textContent = p.stones.toLocaleString();
                if (elements.cultivationPillsDisplay) elements.cultivationPillsDisplay.textContent = p.cultivationPills + " é¢—";
                if (elements.realmPillsDisplay) elements.realmPillsDisplay.textContent = p.realmPills + " é¢—";
                
                const currentPillIds = GameCalculator.getCurrentPillIds(p.realmIndex);
                if (elements.currentPillName) {
                    elements.currentPillName.textContent = currentPillIds.realmPillName;
                }
                
                if (elements.qiBar) elements.qiBar.style.width = qiProgress + "%";
                if (elements.qiProgressText) elements.qiProgressText.textContent = qiProgress + "%";
                if (elements.skillCount) elements.skillCount.textContent = GameState.skillSystem.learned.length;
                if (elements.artifactStatus) elements.artifactStatus.textContent = GameState.artifactSystem.owned ? GameState.artifactSystem.owned.name : 'æœªè£…å¤‡';
                if (elements.sectStatus) elements.sectStatus.textContent = GameState.sectSystem.owned ? GameState.sectSystem.owned.name : 'æœªåŠ å…¥';
                
                const talentContent = document.getElementById("talentContent");
                if (talentContent && GameState.talentSystem) {
                    let talentHTML = '';
                    GameState.talentSystem.forEach(function(talent) { 
                        const className = 'talent-' + talent.type; 
                        talentHTML += '<div class="stat-row"><span class="stat-label ' + className + '">' + talent.name + '</span><span class="stat-value ' + className + '">' + talent.desc + '</span></div>'; 
                    });
                    talentContent.innerHTML = talentHTML;
                }
                
                const specialContent = [];
                if (GameState.skillSystem.learned.length > 0) specialContent.push('<div class="stat-row"><span class="stat-label">åŠŸæ³•</span><span class="stat-value">å·²å­¦ä¹  ' + GameState.skillSystem.learned.length + ' æœ¬</span></div>');
                if (GameState.artifactSystem.owned) specialContent.push('<div class="stat-row"><span class="stat-label">æ³•å®</span><span class="stat-value artifact-name">' + GameState.artifactSystem.owned.name + '</span></div>');
                if (GameState.sectSystem.owned) specialContent.push('<div class="stat-row"><span class="stat-label">å®—é—¨</span><span class="stat-value sect-name">' + GameState.sectSystem.owned.name + '</span></div>');
                if (p.artifactResonance > 0) specialContent.push('<div class="stat-row"><span class="stat-label">æ³•å®å…±é¸£</span><span class="stat-value event-positive">' + p.artifactResonance + 'ç§’</span></div>');
                
                const specialStatusContent = document.getElementById("specialStatusContent");
                if (specialStatusContent) specialStatusContent.innerHTML = specialContent.join('');
                
                if (elements.tribulationWarning) {
                    const daysSinceLast = p.time - (p.lastTribulation || 0);
                    elements.tribulationWarning.style.display = (p.realmIndex >= 2 && daysSinceLast >= 80) ? "block" : "none";
                }
                
                const breakthroughBtn = document.getElementById("breakthroughBtn");
                const successRateContainer = document.getElementById("successRateContainer");
                const successRate = document.getElementById("successRate");
                const pillBonus = document.getElementById("pillBonus");
                
                if (p.qi >= maxQi) {
                    if (breakthroughBtn) breakthroughBtn.style.display = "inline-block";
                    if (successRateContainer) successRateContainer.style.display = "block";
                    const rate = GameCalculator.calculateBreakthroughRate(p);
                    if (successRate) successRate.textContent = rate + "%";
                    if (pillBonus) pillBonus.innerHTML = p.usedRealmPill ? '<span style="color:#4CAF50;"> (å¢ƒç•Œä¸¹+' + Math.floor(GameCalculator.getRealmPill(p.currentRealmPillId).power * (p.pillPowerMultiplier || 1)) + '%)</span>' : '';
                } else {
                    if (breakthroughBtn) breakthroughBtn.style.display = "none";
                    if (successRateContainer) successRateContainer.style.display = "none";
                }
                
                const useCultivationPillBtn = document.getElementById("useCultivationPillBtn");
                const useRealmPillBtn = document.getElementById("useRealmPillBtn");
                
                if (useCultivationPillBtn) {
                    const cultivationPill = GameCalculator.getCultivationPill(currentPillIds.cultivationPillId);
                    useCultivationPillBtn.style.display = (p.cultivationPills > 0 && cultivationPill) ? "inline-block" : "none";
                    if (cultivationPill) {
                        useCultivationPillBtn.textContent = `ğŸ’Š ä½¿ç”¨${cultivationPill.name} (+${cultivationPill.power}ä¿®ä¸º)`;
                    }
                }
                
                if (useRealmPillBtn) {
                    const realmPill = GameCalculator.getRealmPill(currentPillIds.realmPillId);
                    useRealmPillBtn.style.display = (p.realmPills > 0 && realmPill && !p.usedRealmPill && !p.noPills) ? "inline-block" : "none";
                    if (realmPill) {
                        useRealmPillBtn.textContent = `ğŸŒŸ ä½¿ç”¨${realmPill.name} (+${realmPill.power}%æˆåŠŸç‡)`;
                    }
                }
                
                const makePillBtn = document.getElementById("makePillBtn");
                if (makePillBtn && currentPillIds.realmPillId) {
                    const realmPill = GameCalculator.getRealmPill(currentPillIds.realmPillId);
                    if (realmPill) {
                        makePillBtn.textContent = `âš—ï¸ ç‚¼åˆ¶${realmPill.name}`;
                    }
                }
            },
            
            // ... (å…¶ä½™toggleå’Œgenerateæ–¹æ³•ä¿æŒä¸å˜)
            toggleSkillPanel: function() {
                const panel = document.getElementById("skillPanel");
                if (!panel) return;
                const isVisible = panel.style.display === "block";
                panel.style.display = isVisible ? "none" : "block";
                if (!isVisible) GameUI.generateSkillPanelContent();
            },
            
            toggleArtifactPanel: function() {
                const panel = document.getElementById("artifactPanel");
                if (!panel) return;
                const isVisible = panel.style.display === "block";
                panel.style.display = isVisible ? "none" : "block";
                if (!isVisible) GameUI.generateArtifactPanelContent();
            },
            
            toggleSectPanel: function() {
                const panel = document.getElementById("sectPanel");
                if (!panel) return;
                const isVisible = panel.style.display === "block";
                panel.style.display = isVisible ? "none" : "block";
                if (!isVisible) GameUI.generateSectPanelContent();
            },
            
            toggleRelicPanel: function() {
                const panel = document.getElementById("relicPanel");
                if (!panel) return;
                const isVisible = panel.style.display === "block";
                panel.style.display = isVisible ? "none" : "block";
                if (!isVisible) GameUI.generateRelicPanelContent();
            },
            
            togglePillPanel: function() {
                const panel = document.getElementById("pillPanel");
                if (!panel) return;
                const isVisible = panel.style.display === "block";
                panel.style.display = isVisible ? "none" : "block";
                if (!isVisible) GameUI.generatePillPanelContent();
            },
            
            generateSkillPanelContent: function() {
                const content = document.getElementById("skillPanelContent");
                if (!content) return;
                const p = GameState.player;
                let html = '<div class="panel-section"><h3>å¯å­¦ä¹ åŠŸæ³•</h3>';
                GameConfig.skills.forEach(function(skill) {
                    const isLearned = GameState.skillSystem.learned.some(function(s) { return s.id === skill.id; });
                    const canLearn = p.realmIndex >= skill.realmReq;
                    let cost = skill.cost;
                    if (p.skillCostDiscount) cost = Math.floor(cost * p.skillCostDiscount);
                    if (p.priceIncrease) cost = Math.floor(cost * p.priceIncrease);
                    html += '<div style="margin:15px 0; padding:10px; border:1px solid #333; border-radius:5px;"><div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px;"><div style="text-align:left; flex: 1; min-width: 200px;"><span style="font-weight:bold;">' + skill.name + '</span><div style="font-size: var(--font-size-sm); color: #aaa; margin-top: 3px;">' + skill.desc + '</div><div style="font-size: var(--font-size-sm);">åŠ æˆ: +' + skill.bonus + ' é€Ÿåº¦</div></div>' + (isLearned ? '<span style="color:#4CAF50; font-weight:bold;">å·²å­¦ä¹ </span>' : (!canLearn ? '<span style="color:#888; font-size: var(--font-size-sm);">éœ€è¦' + GameConfig.realmSystem[skill.realmReq].name + '</span>' : '<button onclick="GameActions.learnSkill(\'' + skill.id + '\')" class="btn-primary" style="min-width:80px; padding:8px; font-size: var(--font-size-sm);">' + cost + ' çµçŸ³</button>')) + '</div></div>';
                });
                html += '</div><div class="panel-section"><h3>å½“å‰åŠ æˆ</h3><div class="stat-row"><span class="stat-label">åŠŸæ³•æ€»åŠ æˆ</span><span class="stat-value skill-effective">+' + GameCalculator.calculateSkillBonus(GameState.skillSystem, p) + ' é€Ÿåº¦</span></div></div>';
                content.innerHTML = html;
            },
            
            generateArtifactPanelContent: function() {
                const content = document.getElementById("artifactPanelContent");
                if (!content) return;
                const p = GameState.player;
                let html = '<div class="panel-section"><h3>å¯è·å¾—æ³•å®</h3>';
                GameConfig.artifacts.forEach(function(artifact) {
                    const isOwned = GameState.artifactSystem.owned && GameState.artifactSystem.owned.id === artifact.id;
                    const canEquip = p.realmIndex >= artifact.realmReq;
                    let cost = artifact.cost;
                    if (p.priceIncrease) cost = Math.floor(cost * p.priceIncrease);
                    html += '<div style="margin:15px 0; padding:10px; border:1px solid #333; border-radius:5px;"><div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px;"><div style="text-align:left; flex: 1; min-width: 200px;"><span class="artifact-name" style="font-weight:bold;">' + artifact.name + '</span><div style="font-size: var(--font-size-sm); color: #aaa; margin-top: 3px;">' + artifact.desc + '</div><div style="font-size: var(--font-size-sm);">åŠ æˆ: +' + artifact.bonus + ' é€Ÿåº¦</div></div>' + (isOwned ? '<span style="color:#4CAF50; font-weight:bold;">å·²è£…å¤‡</span>' : (!canEquip ? '<span style="color:#888; font-size: var(--font-size-sm);">éœ€è¦' + GameConfig.realmSystem[artifact.realmReq].name + '</span>' : '<button onclick="GameActions.obtainArtifact(\'' + artifact.id + '\')" class="btn-primary" style="min-width:80px; padding:8px; font-size: var(--font-size-sm);">' + cost + ' çµçŸ³</button>')) + '</div></div>';
                });
                html += '</div><div class="panel-section"><h3>å½“å‰è£…å¤‡</h3>';
                if (GameState.artifactSystem.owned) {
                    const artifact = GameState.artifactSystem.owned;
                    const currentBonus = GameCalculator.calculateArtifactBonus(GameState.artifactSystem, p);
                    html += '<div class="stat-row"><span class="stat-label">è£…å¤‡æ³•å®</span><span class="stat-value artifact-name">' + artifact.name + '</span></div><div class="stat-row"><span class="stat-label">å½“å‰åŠ æˆ</span><span class="stat-value">+' + currentBonus + ' é€Ÿåº¦</span></div>';
                } else {
                    html += '<div style="color:#888;">å°šæœªè£…å¤‡ä»»ä½•æ³•å®</div>';
                }
                html += '</div>';
                content.innerHTML = html;
            },
            
            generateSectPanelContent: function() {
                const content = document.getElementById("sectPanelContent");
                if (!content) return;
                const p = GameState.player;
                let html = '<div class="panel-section"><h3>å¯åŠ å…¥å®—é—¨</h3>';
                if (p.cantJoinSect) {
                    html += '<div style="color:#f44336; padding:10px;">å¤©èµ‹é™åˆ¶ï¼šæ— æ³•åŠ å…¥ä»»ä½•å®—é—¨</div>';
                } else {
                    GameConfig.sects.forEach(function(sect) {
                        const isJoined = GameState.sectSystem.owned && GameState.sectSystem.owned.id === sect.id;
                        const canJoin = p.realmIndex >= sect.realmReq;
                        let cost = sect.joinCost;
                        if (p.priceIncrease) cost = Math.floor(cost * p.priceIncrease);
                        html += '<div style="margin:15px 0; padding:10px; border:1px solid #333; border-radius:5px;"><div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px;"><div style="text-align:left; flex: 1; min-width: 200px;"><span class="sect-name" style="font-weight:bold;">' + sect.name + '</span><div style="font-size: var(--font-size-sm); color: #aaa; margin-top: 3px;">' + sect.desc + '</div><div style="font-size: var(--font-size-sm);">åŠ æˆ: +' + sect.benefit.speed + ' é€Ÿåº¦</div></div>' + (isJoined ? '<span style="color:#4CAF50; font-weight:bold;">å·²åŠ å…¥</span>' : (!canJoin ? '<span style="color:#888; font-size: var(--font-size-sm);">éœ€è¦' + GameConfig.realmSystem[sect.realmReq].name + '</span>' : '<button onclick="GameActions.joinSect(\'' + sect.id + '\')" class="btn-primary" style="min-width:80px; padding:8px; font-size: var(--font-size-sm);">' + cost + ' çµçŸ³</button>')) + '</div></div>';
                    });
                }
                html += '</div><div class="panel-section"><h3>å½“å‰å®—é—¨</h3>';
                if (GameState.sectSystem.owned) {
                    const sect = GameState.sectSystem.owned;
                    html += '<div class="stat-row"><span class="stat-label">æ‰€å±å®—é—¨</span><span class="stat-value sect-name">' + sect.name + '</span></div><div class="stat-row"><span class="stat-label">å®—é—¨åŠ æˆ</span><span class="stat-value">+' + sect.benefit.speed + ' é€Ÿåº¦</span></div><div class="stat-row"><span class="stat-label">å®—é—¨è´¡çŒ®</span><span class="stat-value sect-contribution">' + GameState.sectSystem.contribution + '</span></div>';
                } else {
                    html += '<div style="color:#888;">å°šæœªåŠ å…¥ä»»ä½•å®—é—¨</div>';
                }
                html += '</div>';
                content.innerHTML = html;
            },
            
            generateRelicPanelContent: function() {
                const content = document.getElementById("relicPanelContent");
                if (!content) return;
                const p = GameState.player;
                let html = '<div class="panel-section"><h3>å¯æ¢ç´¢é—è¿¹</h3>';
                GameConfig.relics.forEach(function(relic) {
                    const thiefExtra = p.thiefBonus ? ' (+20-50çµçŸ³)' : '';
                    const cost = relic.cost + (p.thiefBonus ? 2 : 0);
                    html += '<div style="margin:15px 0; padding:10px; border:1px solid #333; border-radius:5px;"><div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px;"><div style="text-align:left; flex: 1; min-width: 200px;"><span class="relic-name" style="font-weight:bold;">' + relic.name + '</span><div style="font-size: var(--font-size-sm); color: #aaa; margin-top: 3px;">' + relic.desc + '</div><div style="font-size: var(--font-size-sm);">æ¶ˆè€—: ' + cost + ' å¹´å¯¿å…ƒ</div><div style="font-size: var(--font-size-sm);">å¥–åŠ±: ' + relic.minReward + '-' + relic.maxReward + ' çµçŸ³' + thiefExtra + '</div>' + (p.thiefBonus ? '<div style="font-size: var(--font-size-sm); color:#FFC107;">é¢å¤–ï¼šç›—è´¼å¤©èµ‹é™„åŠ å¥–åŠ±</div>' : '') + '</div><button onclick="GameActions.exploreRelic(\'' + relic.id + '\')" class="btn-primary" style="min-width:80px; padding:8px; font-size: var(--font-size-sm);">æ¢ç´¢</button></div>';
                });
                html += '</div><div class="panel-section"><h3>æ¢ç´¢è¯´æ˜</h3><div style="color:#aaa; font-size: var(--font-size-sm);">æ¢ç´¢é—è¿¹ä¼šæ¶ˆè€—å¯¿å…ƒï¼Œä½†å¯è·å¾—å¤§é‡çµçŸ³ã€‚å¯¿å…ƒéšæ—¶é—´æµé€ï¼ˆæ¯ç§’å‡å°‘1å¤©ï¼‰ï¼Œè¯·åˆç†åˆ†é…ã€‚</div></div>';
                content.innerHTML = html;
            },
            
            generatePillPanelContent: function() {
                const content = document.getElementById("pillPanelContent");
                if (!content) return;
                
                const p = GameState.player;
                let html = '';
                
                html += '<div class="current-pill-info">';
                html += '<div class="current-pill-title">å½“å‰å¢ƒç•Œä¸¹è¯é…ç½®</div>';
                
                const currentPillIds = GameCalculator.getCurrentPillIds(p.realmIndex);
                const cultivationPill = GameCalculator.getCultivationPill(currentPillIds.cultivationPillId);
                const realmPill = GameCalculator.getRealmPill(currentPillIds.realmPillId);
                
                html += '<div class="stat-row"><span class="stat-label">ä¿®ä¸ºä¸¹</span><span class="stat-value">'+ (cultivationPill ? cultivationPill.name : 'æ— ') +'</span></div>';
                html += '<div class="stat-row"><span class="stat-label">å¢ƒç•Œä¸¹</span><span class="stat-value">'+ (realmPill ? realmPill.name : 'æ— ') +'</span></div>';
                html += '</div>';
                
                html += '<div class="pill-type-section">';
                html += '<div class="pill-type-title pill-type-cultivation">ğŸ’Š ä¿®ä¸ºä¸¹ï¼ˆç›´æ¥å¢åŠ ä¿®ä¸ºï¼‰</div>';
                GameConfig.cultivationPills.forEach(function(pill) {
                    const canUse = p.realmIndex >= pill.minRealm;
                    const inventory = GameState.pillSystem.cultivationPills[pill.id] || 0;
                    
                    html += '<div class="pill-item">';
                    html += '<div class="pill-name">'+ pill.name +'</div>';
                    html += '<div class="pill-desc">'+ pill.desc +'</div>';
                    html += '<div class="pill-stats">';
                    html += '<div class="stat-item"><span>å¢ƒç•Œè¦æ±‚:</span><span>'+ (pill.minRealm === 0 ? 'ç‚¼æ°”æœŸ' : GameConfig.realmSystem[pill.minRealm].name) +'</span></div>';
                    html += '<div class="stat-item"><span>å¢åŠ ä¿®ä¸º:</span><span class="event-positive">+'+ pill.power +'</span></div>';
                    html += '<div class="stat-item"><span>ç‚¼åˆ¶æˆæœ¬:</span><span class="cost-highlight">'+ pill.cost +'çµçŸ³</span></div>';
                    html += '<div class="stat-item"><span>å½“å‰åº“å­˜:</span><span class="pill-name">'+ inventory +'é¢—</span></div>';
                    html += '</div>';
                    html += '</div>';
                });
                html += '</div>';
                
                html += '<div class="pill-type-section">';
                html += '<div class="pill-type-title pill-type-realm">ğŸŒŸ å¢ƒç•Œä¸¹ï¼ˆæå‡çªç ´æˆåŠŸç‡ï¼‰</div>';
                GameConfig.realmPills.forEach(function(pill) {
                    const inventory = GameState.pillSystem.realmPills[pill.id] || 0;
                    
                    html += '<div class="pill-item">';
                    html += '<div class="pill-name">'+ pill.name +'</div>';
                    html += '<div class="pill-desc">'+ pill.desc +'</div>';
                    html += '<div class="pill-stats">';
                    html += '<div class="stat-item"><span>é€‚ç”¨å¢ƒç•Œ:</span><span>'+ GameConfig.realmSystem[pill.minRealm].name +' - '+ GameConfig.realmSystem[pill.maxRealm].name +'</span></div>';
                    html += '<div class="stat-item"><span>æˆåŠŸç‡åŠ æˆ:</span><span class="event-positive">+'+ pill.power +'%</span></div>';
                    html += '<div class="stat-item"><span>ç‚¼åˆ¶æˆæœ¬:</span><span class="cost-highlight">'+ pill.cost +'çµçŸ³</span></div>';
                    html += '<div class="stat-item"><span>å½“å‰åº“å­˜:</span><span class="pill-name">'+ inventory +'é¢—</span></div>';
                    html += '</div>';
                    html += '</div>';
                });
                html += '</div>';
                
                content.innerHTML = html;
            },
            
            log: function(message) {
                const logElement = document.getElementById("log");
                if (!logElement) return;
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement("div");
                logEntry.innerHTML = '[' + timestamp + '] ' + message;
                const existingLogs = Array.from(logElement.children);
                if (existingLogs.length >= 20) {
                    for (let i = 0; i < existingLogs.length - 19; i++) {
                        logElement.removeChild(existingLogs[i]);
                    }
                }
                logElement.appendChild(logEntry);
                logElement.scrollTop = logElement.scrollHeight;
                debugLog("æ—¥å¿—:", message);
            }
        };

        window.GameActions = {
            cultivate: function() {
                const p = GameState.player;
                if (!p) return;
                const skillBonus = GameCalculator.calculateSkillBonus(GameState.skillSystem, p);
                const artifactBonus = GameCalculator.calculateArtifactBonus(GameState.artifactSystem, p);
                const sectBonus = GameCalculator.getSectBonus(GameState.sectSystem, "speed", p);
                const realmSpeedBonus = GameCalculator.getRealmSpeedBonus(p.realmIndex);
                
                let totalSpeed = ((p.baseSpeed || 1) + realmSpeedBonus + skillBonus + artifactBonus + sectBonus) * (p.globalBonus || 1) * (p.qiGainBonus || 1);
                if (p.artifactResonance > 0) totalSpeed *= 1.5;
                if (p.manualCultivateBonus) totalSpeed *= p.manualCultivateBonus;
                if (p.manualCultivatePenalty) totalSpeed *= p.manualCultivatePenalty;
                const oldQi = p.qi;
                p.qi += totalSpeed;
                GameUI.log('ğŸ§˜ ä¿®ç‚¼ +' + (p.qi - oldQi).toFixed(1));
                GameUI.update();
            },
            
            toggleAutoCultivate: function() {
                const btn = document.getElementById("autoCultivateBtn");
                if (!btn) return;
                GameState.autoCultivating = !GameState.autoCultivating;
                btn.textContent = GameState.autoCultivating ? "ğŸ¤– å…³é—­è‡ªåŠ¨ä¿®ç‚¼" : "ğŸ¤– å¼€å¯è‡ªåŠ¨ä¿®ç‚¼";
                btn.style.background = GameState.autoCultivating ? "linear-gradient(135deg, #FF5722, #FF9800)" : "linear-gradient(135deg, #0f3460, #1e5a8c)";
                GameUI.log(GameState.autoCultivating ? "ğŸ¤– è‡ªåŠ¨ä¿®ç‚¼å·²å¼€å¯" : "ğŸ¤– è‡ªåŠ¨ä¿®ç‚¼å·²å…³é—­");
            },
            
            upgrade: function() {
                const p = GameState.player;
                let cost = GameCalculator.getUpgradeCost(p);
                cost = Math.floor(cost * (p.priceIncrease || 1));
                if (p.stones >= cost) { p.stones -= cost; p.baseSpeed = (p.baseSpeed || 1) + 0.5; GameUI.log('ğŸ“ˆ èµ„è´¨æå‡ï¼åŸºç¡€ä¿®ç‚¼é€Ÿåº¦ +0.5'); GameUI.update(); } else { GameUI.log('âš ï¸ çµçŸ³ä¸è¶³ï¼Œéœ€è¦ ' + cost + ' çµçŸ³'); }
            },
            
            makePill: function() {
                const p = GameState.player;
                const pillSystem = GameState.pillSystem;
                if (p.noPills) { GameUI.log('âš ï¸ è‹¦ä¿®è€…å¤©èµ‹ï¼šæ— æ³•ä½¿ç”¨ä¸¹è¯'); return; }
                
                const currentPillIds = GameCalculator.getCurrentPillIds(p.realmIndex);
                const realmPill = GameCalculator.getRealmPill(currentPillIds.realmPillId);
                
                if (!realmPill) {
                    GameUI.log('âŒ å½“å‰å¢ƒç•Œæ— å¯ç”¨ä¸¹è¯ï¼');
                    return;
                }
                
                let cost = p.pillCost || realmPill.cost;
                cost = Math.floor(cost * (p.priceIncrease || 1));
                if (p.stones >= cost) {
                    p.stones -= cost;
                    
                    if (!pillSystem.realmPills[currentPillIds.realmPillId]) {
                        pillSystem.realmPills[currentPillIds.realmPillId] = 0;
                    }
                    pillSystem.realmPills[currentPillIds.realmPillId] += 1;
                    p.realmPills += 1;
                    
                    p.pillCost = Math.floor((p.pillCost || realmPill.cost) * 1.5);
                    
                    GameUI.log('âš—ï¸ æˆåŠŸç‚¼åˆ¶ ' + realmPill.name + ' x1 â†’ ä¸‹æ¬¡æˆæœ¬ï¼š' + p.pillCost + 'çµçŸ³');
                } else {
                    GameUI.log('âš ï¸ çµçŸ³ä¸è¶³ï¼Œéœ€è¦ ' + cost + ' çµçŸ³');
                }
                GameUI.update();
            },
            
            useCultivationPill: function() {
                const p = GameState.player;
                const pillSystem = GameState.pillSystem;
                if (p.noPills) { GameUI.log('âš ï¸ è‹¦ä¿®è€…å¤©èµ‹ï¼šæ— æ³•ä½¿ç”¨ä¸¹è¯'); return; }
                
                const currentPillIds = GameCalculator.getCurrentPillIds(p.realmIndex);
                const cultivationPill = GameCalculator.getCultivationPill(currentPillIds.cultivationPillId);
                
                if (!cultivationPill) {
                    GameUI.log('âŒ å½“å‰å¢ƒç•Œæ— å¯ç”¨ä¿®ä¸ºä¸¹ï¼');
                    return;
                }
                
                if (p.cultivationPills > 0 && pillSystem.cultivationPills[currentPillIds.cultivationPillId] > 0) {
                    const oldQi = p.qi;
                    p.qi = Math.min(p.qi + cultivationPill.power, GameCalculator.getMaxQi(p.realmIndex, p.stageIndex));
                    const gained = p.qi - oldQi;
                    
                    pillSystem.cultivationPills[currentPillIds.cultivationPillId] -= 1;
                    p.cultivationPills -= 1;
                    
                    GameUI.log('ğŸ’Š ä½¿ç”¨' + cultivationPill.name + 'ï¼Œä¿®ä¸ºæå‡' + gained.toFixed(0));
                    GameUI.update();
                }
            },
            
            useRealmPill: function() {
                const p = GameState.player;
                if (p.noPills) { GameUI.log('âš ï¸ è‹¦ä¿®è€…å¤©èµ‹ï¼šæ— æ³•ä½¿ç”¨ä¸¹è¯'); return; }
                
                const currentPillIds = GameCalculator.getCurrentPillIds(p.realmIndex);
                const realmPill = GameCalculator.getRealmPill(currentPillIds.realmPillId);
                
                if (!realmPill) {
                    GameUI.log('âŒ å½“å‰å¢ƒç•Œæ— å¯ç”¨å¢ƒç•Œä¸¹ï¼');
                    return;
                }
                
                if (p.realmPills > 0 && !p.usedRealmPill) {
                    p.usedRealmPill = true;
                    GameUI.log('ğŸ’Š æœç”¨' + realmPill.name + 'ï¼Œçªç ´æˆåŠŸç‡ +' + Math.floor(realmPill.power * (p.pillPowerMultiplier || 1)) + '%');
                    GameUI.update();
                } else {
                    GameUI.log('âš ï¸ å¢ƒç•Œä¸¹æ•°é‡ä¸è¶³æˆ–å·²ä½¿ç”¨');
                }
            },
            
            attemptBreakthrough: function() {
                const p = GameState.player;
                if (!p) return;
                const maxQi = GameCalculator.getMaxQi(p.realmIndex, p.stageIndex);
                if (p.qi < maxQi) { GameUI.log("âš ï¸ ä¿®ä¸ºä¸è¶³ï¼Œæ— æ³•çªç ´"); return; }
                const successRate = GameCalculator.calculateBreakthroughRate(p);
                GameUI.log('ğŸ”¥ å¼€å§‹çªç ´... æˆåŠŸç‡: ' + successRate + '%');
                if (Math.random() * 100 < successRate) {
                    const oldRealmIndex = p.realmIndex;
                    p.stageIndex++;
                    const realm = GameConfig.realmSystem[p.realmIndex];
                    if (p.stageIndex >= realm.stages.length) {
                        if (p.realmIndex < GameConfig.realmSystem.length - 1) {
                            p.realmIndex++; p.stageIndex = 0;
                            // æ–°å¢ï¼šå¤§å¢ƒç•Œçªç ´æ—¶å¢åŠ ä¿®ç‚¼é€Ÿåº¦
                            const realmBonus = GameCalculator.getRealmSpeedBonus(p.realmIndex);
                            GameUI.log('ğŸ‰ <span class="realm-reward">ã€å¤§å¢ƒç•Œçªç ´ã€‘</span> æˆåŠŸè¿›å…¥' + GameConfig.realmSystem[p.realmIndex].name + 'ï¼');
                            GameUI.log('âœ¨ <span class="realm-reward">å¢ƒç•Œçªç ´ï¼ä¿®ç‚¼é€Ÿåº¦ +' + realmBonus + ' ç‚¹/ç§’</span>');
                            const lifespanReward = [0, 50, 80, 120, 200][p.realmIndex] || 0;
                            if (lifespanReward > 0) { p.maxLifespan += lifespanReward * 365; p.lifespan += lifespanReward * 365; GameUI.log('âœ¨ <span class="realm-reward">å¯¿å…ƒå¢åŠ ' + lifespanReward + 'å¹´ï¼</span>'); }
                            if (p.realmIndex < 4) { 
                                const newPillIds = GameCalculator.getCurrentPillIds(p.realmIndex);
                                p.currentRealmPillId = newPillIds.realmPillId;
                            }
                        } else { 
                            p.stageIndex = realm.stages.length - 1; 
                            GameUI.log('ğŸ‰ <span class="realm-reward">ã€å¢ƒç•Œåœ†æ»¡ã€‘</span> ä½ å·²ç«™åœ¨ä¿®ä»™ç•Œå·…å³°ï¼'); 
                        }
                    } else {
                        GameUI.log('ğŸ‰ <span class="realm-reward">ã€å°å¢ƒç•Œçªç ´ã€‘</span> æˆåŠŸçªç ´åˆ°' + realm.stages[p.stageIndex] + 'ï¼');
                        addStageLifespanReward(p, p.realmIndex);
                    }
                    
                    if (p.usedRealmPill && p.currentRealmPillId) {
                        GameState.pillSystem.realmPills[p.currentRealmPillId] = Math.max(0, (GameState.pillSystem.realmPills[p.currentRealmPillId] || 0) - 1);
                        p.realmPills = Math.max(0, p.realmPills - 1);
                    }
                    
                    p.qi = 0; 
                    p.usedRealmPill = false; 
                    p.breakthroughDifficulty = 1;
                    if (p.phoenixBlessing) { p.lifespan = Math.min(p.lifespan + 30, p.maxLifespan); GameUI.log('ğŸ”¥ å‡¤å‡°è¡€è„‰è§¦å‘ï¼å¯¿å…ƒæ¢å¤30å¤©'); }
                } else {
                    const qiLoss = Math.floor(maxQi * 0.3);
                    p.qi = Math.max(0, p.qi - qiLoss);
                    p.usedRealmPill = false;
                    p.breakthroughDifficulty = (p.breakthroughDifficulty || 1) + 0.2;
                    GameUI.log('ğŸ’” <span class="event-negative">ã€çªç ´å¤±è´¥ã€‘</span> ä¿®ä¸ºæŸå¤±' + qiLoss + 'ï¼');
                }
                GameUI.update();
            },
            
            learnSkill: function(skillId) {
                const p = GameState.player;
                const skill = GameConfig.skills.find(function(s) { return s.id === skillId; });
                if (!skill) return;
                let cost = skill.cost;
                if (p.skillCostDiscount) cost = Math.floor(cost * p.skillCostDiscount);
                if (p.priceIncrease) cost = Math.floor(cost * p.priceIncrease);
                if (p.stones >= cost) { p.stones -= cost; GameState.skillSystem.learned.push(skill); GameUI.log('ğŸ“œ å­¦ä¼šæ–°åŠŸæ³•: ' + skill.name + 'ï¼'); GameUI.update(); } else { GameUI.log('âš ï¸ çµçŸ³ä¸è¶³ï¼Œéœ€è¦ ' + cost + ' çµçŸ³'); }
            },
            
            obtainArtifact: function(artifactId) {
                const p = GameState.player;
                const artifact = GameConfig.artifacts.find(function(a) { return a.id === artifactId; });
                if (!artifact) return;
                let cost = artifact.cost;
                if (p.priceIncrease) cost = Math.floor(cost * p.priceIncrease);
                if (p.stones >= cost) { p.stones -= cost; GameState.artifactSystem.owned = artifact; GameUI.log('ğŸ—¡ï¸ è·å¾—æ³•å®: ' + artifact.name + 'ï¼'); GameUI.update(); } else { GameUI.log('âš ï¸ çµçŸ³ä¸è¶³ï¼Œéœ€è¦ ' + cost + ' çµçŸ³'); }
            },
            
            joinSect: function(sectId) {
                const p = GameState.player;
                const sect = GameConfig.sects.find(function(s) { return s.id === sectId; });
                if (!sect) return;
                if (p.cantJoinSect) { GameUI.log('âš ï¸ å¤©èµ‹é™åˆ¶ï¼šæ— æ³•åŠ å…¥å®—é—¨'); return; }
                let cost = sect.joinCost;
                if (p.priceIncrease) cost = Math.floor(cost * p.priceIncrease);
                if (p.stones >= cost) { p.stones -= cost; GameState.sectSystem.owned = sect; GameState.sectSystem.contribution = 0; GameUI.log('ğŸ›ï¸ æˆåŠŸåŠ å…¥å®—é—¨: ' + sect.name + 'ï¼'); GameUI.update(); } else { GameUI.log('âš ï¸ çµçŸ³ä¸è¶³ï¼Œéœ€è¦ ' + cost + ' çµçŸ³'); }
            },
            
            exploreRelic: function(relicId) {
                const p = GameState.player;
                const relic = GameConfig.relics.find(function(r) { return r.id === relicId; });
                if (!relic) return;
                const cost = relic.cost + (p.thiefBonus ? 2 : 0);
                if (p.lifespan < cost * 365) { GameUI.log('âš ï¸ å¯¿å…ƒä¸è¶³ï¼Œéœ€è¦ ' + cost + ' å¹´å¯¿å…ƒ'); return; }
                p.lifespan -= cost * 365;
                const baseReward = Math.floor(Math.random() * (relic.maxReward - relic.minReward + 1)) + relic.minReward;
                const thiefBonus = p.thiefBonus ? Math.floor(Math.random() * 31) + 20 : 0;
                const totalReward = Math.floor((baseReward + thiefBonus) * (p.moneyBonus || 1));
                p.stones += totalReward;
                GameUI.log('ğŸ›ï¸ <span class="event-positive">æ¢ç´¢' + relic.name + 'æˆåŠŸï¼</span> è·å¾— ' + totalReward + ' çµçŸ³ (æ¶ˆè€—' + cost + 'å¹´å¯¿å…ƒ)');
                if (thiefBonus > 0) GameUI.log('ğŸ’° ç›—è´¼å¤©èµ‹é¢å¤–è·å¾— ' + thiefBonus + ' çµçŸ³ï¼');
                GameUI.update();
            },
            
            triggerRandomEvent: function() {
                const p = GameState.player;
                const events = GameConfig.randomEvents;
                const quality = p.luck >= 2 ? 1.5 : 1;
                p.eventQuality = quality;
                const randomIndex = Math.floor(Math.random() * events.length);
                const event = events[randomIndex];
                event.effect(p);
                debugLog("è§¦å‘éšæœºäº‹ä»¶:", event.name);
            },
            
            triggerTribulation: function() {
                const p = GameState.player;
                p.lastTribulation = p.time;
                const tribulationPower = p.realmIndex * 0.3;
                const successRate = Math.max(10, 80 - tribulationPower * 20);
                GameUI.log('âš¡ <span class="tribulation-warning">ã€å¤©åŠ«é™ä¸´ã€‘</span> å¨åŠ›ç­‰çº§ï¼š' + (p.realmIndex + 1));
                if (Math.random() * 100 < successRate) {
                    const reward = Math.floor(p.maxLifespan * 0.1);
                    p.maxLifespan += reward;
                    p.lifespan = Math.min(p.lifespan + reward, p.maxLifespan);
                    GameUI.log('ğŸ‰ <span class="event-positive">ã€æ¸¡åŠ«æˆåŠŸã€‘</span> å¯¿å…ƒå¢åŠ ' + Math.floor(reward/365) + 'å¹´ï¼');
                } else {
                    const penalty = Math.floor(p.maxLifespan * 0.05);
                    p.maxLifespan = Math.max(365, p.maxLifespan - penalty);
                    p.lifespan = Math.min(p.lifespan, p.maxLifespan);
                    GameUI.log('ğŸ’€ <span class="event-negative">ã€æ¸¡åŠ«å¤±è´¥ã€‘</span> å¯¿å…ƒå‡å°‘' + Math.floor(penalty/365) + 'å¹´ï¼');
                }
            },
            
            saveGame: function() {
                const saveData = { 
                    player: GameState.player, 
                    skillSystem: GameState.skillSystem, 
                    artifactSystem: GameState.artifactSystem, 
                    sectSystem: GameState.sectSystem, 
                    talentSystem: GameState.talentSystem,
                    pillSystem: GameState.pillSystem,
                    version: "v1.5-ä¸¹è¯é‡æ„ç‰ˆ + å¢ƒç•Œé€Ÿåº¦åŠ æˆ" 
                };
                localStorage.setItem("immortalCultivatorSave", JSON.stringify(saveData));
                GameUI.log("ğŸ’¾ æ¸¸æˆå·²ä¿å­˜");
                const status = document.getElementById("saveStatus");
                if (status) { status.textContent = "å·²ä¿å­˜"; status.style.color = "#4CAF50"; setTimeout(function() { status.textContent = ""; }, 2000); }
            },
            
            loadGame: function() {
                const saved = localStorage.getItem("immortalCultivatorSave");
                if (!saved) { GameUI.log("âš ï¸ æ²¡æœ‰æ‰¾åˆ°å­˜æ¡£"); return; }
                try {
                    const saveData = JSON.parse(saved);
                    GameState.player = saveData.player;
                    GameState.skillSystem = saveData.skillSystem || { learned: [] };
                    GameState.artifactSystem = saveData.artifactSystem || { owned: null };
                    GameState.sectSystem = saveData.sectSystem || { owned: null, contribution: 0 };
                    GameState.talentSystem = saveData.talentSystem || [];
                    GameState.pillSystem = saveData.pillSystem || { cultivationPills: {}, realmPills: {} };
                    
                    GameConfig.cultivationPills.forEach(pill => {
                        if (GameState.pillSystem.cultivationPills[pill.id] === undefined) {
                            GameState.pillSystem.cultivationPills[pill.id] = 0;
                        }
                    });
                    GameConfig.realmPills.forEach(pill => {
                        if (GameState.pillSystem.realmPills[pill.id] === undefined) {
                            GameState.pillSystem.realmPills[pill.id] = 0;
                        }
                    });
                    
                    if (GameState.player && GameCalculator.getRealmPill(GameState.player.currentRealmPillId)) {
                        GameState.player.pillCost = GameState.player.pillCost || GameCalculator.getRealmPill(GameState.player.currentRealmPillId).cost;
                    }
                    GameUI.log("ğŸ“‚ æ¸¸æˆå·²è¯»å–");
                    GameUI.update();
                } catch (e) {
                    GameUI.log("âš ï¸ å­˜æ¡£æŸåï¼Œæ— æ³•è¯»å–");
                    console.error(e);
                }
            }
        };

        window.GameLoop = {
            update: function() {
                const p = GameState.player;
                if (!p) return;
                p.time++;
                p.lifespan--;
                if (p.lifespan <= 0) {
                    GameUI.log("ğŸ’€ å¯¿å…ƒè€—å°½ï¼Œä½ é™¨è½äº†...");
                    clearInterval(GameState.gameLoop);
                    GameState.gameLoop = null;
                    return;
                }
                if (GameState.autoCultivating) {
                    GameActions.cultivate();
                    GameState.autoCultivateLogTimer++;
                    if (GameState.autoCultivateLogTimer >= 10) GameState.autoCultivateLogTimer = 0;
                }
                if (p.artifactResonance > 0) p.artifactResonance--;
                const eventChance = 0.01 * (p.luck || 1);
                if (Math.random() < eventChance) GameActions.triggerRandomEvent();
                if (p.realmIndex >= 2) {
                    const daysSinceLast = p.time - (p.lastTribulation || 0);
                    if (daysSinceLast >= 90) GameActions.triggerTribulation();
                }
                GameUI.update();
            }
        };

        window.startGame = function() {
            if (GameState.gameStarted) {
                console.log("ã€è­¦å‘Šã€‘æ¸¸æˆå·²ç»å¯åŠ¨ï¼Œå¿½ç•¥é‡å¤çš„startGameè°ƒç”¨");
                return;
            }
            
            console.log("========== ã€å¼€å§‹æ¸¸æˆã€‘å‡½æ•°è¢«è°ƒç”¨ ==========");
            console.log("ç‰ˆæœ¬:", window.version);
            
            try {
                GameState.player = {
                    name: "ä¿®ä»™è€…",
                    initialAge: 18,
                    realmIndex: 0,
                    stageIndex: 0,
                    qi: 0,
                    stones: 50,
                    cultivationPills: 0,
                    realmPills: 0,
                    currentRealmPillId: GameCalculator.getCurrentPillIds(0).realmPillId,
                    baseSpeed: 1,
                    lifespan: 20 * 365,
                    maxLifespan: 20 * 365,
                    breakthroughBonus: 0,
                    usedRealmPill: false,
                    time: 0,
                    luck: 1,
                    eventQuality: 1,
                    globalBonus: 1,
                    qiGainBonus: 1,
                    moneyBonus: 1,
                    pillPowerMultiplier: 1,
                    pillCost: GameCalculator.getRealmPill(GameCalculator.getCurrentPillIds(0).realmPillId).cost,
                    skillBoost: 1,
                    skillPenalty: 1,
                    skillEffectPenalty: 1,
                    artifactBoost: 1,
                    artifactPenalty: 1,
                    sectBonusBoost: 1,
                    priceIncrease: 1,
                    breakthroughDifficulty: 1,
                    manualCultivateBonus: 1,
                    manualCultivatePenalty: 1,
                    noPills: false,
                    cantJoinSect: false,
                    phoenixBlessing: false,
                    breakthroughRandom: false,
                    artifactResonance: 0,
                    lastTribulation: 0,
                    thiefBonus: false
                };
                
                GameState.skillSystem = { learned: [] };
                GameState.artifactSystem = { owned: null };
                GameState.sectSystem = { owned: null, contribution: 0 };
                
                GameState.pillSystem = { 
                    cultivationPills: {}, 
                    realmPills: {} 
                };
                GameConfig.cultivationPills.forEach(pill => {
                    if (!GameState.pillSystem.cultivationPills[pill.id]) {
                        GameState.pillSystem.cultivationPills[pill.id] = 0;
                    }
                });
                GameConfig.realmPills.forEach(pill => {
                    if (!GameState.pillSystem.realmPills[pill.id]) {
                        GameState.pillSystem.realmPills[pill.id] = 0;
                    }
                });
                
                GameState.talentSystem = [];
                const availableTalents = [...GameConfig.talents];
                for (let i = 0; i < 3; i++) {
                    const randomIndex = Math.floor(Math.random() * availableTalents.length);
                    const selectedTalent = availableTalents[randomIndex];
                    GameState.talentSystem.push(selectedTalent);
                    selectedTalent.effect(GameState.player);
                    if (selectedTalent.id === "thief") GameState.player.thiefBonus = true;
                }
                
                console.log("ã€ç©å®¶æ•°æ®ã€‘åˆå§‹åŒ–å®Œæˆ:", GameState.player);
                console.log("ã€å¤©èµ‹ã€‘é€‰æ‹©å®Œæˆ:", GameState.talentSystem.map(function(t) { return t.name; }));
                
                GameUI.initStableUI();
                
                const cover = document.getElementById('coverContainer');
                const game = document.getElementById('gameContainer');
                if (cover) {
                    cover.style.opacity = '0';
                    setTimeout(function() {
                        cover.style.display = 'none';
                        if (game) {
                            game.style.display = 'block';
                            game.style.opacity = '0';
                            setTimeout(function() {
                                game.style.opacity = '1';
                                game.style.transition = 'opacity 0.5s ease';
                            }, 50);
                        }
                    }, 500);
                }
                
                if (GameState.gameLoop) {
                    clearInterval(GameState.gameLoop);
                    GameState.gameLoop = null;
                }
                GameState.gameLoop = setInterval(function() { GameLoop.update(); }, 1000);
                console.log("ã€æ¸¸æˆå¾ªç¯ã€‘å·²å¯åŠ¨");
                
                GameUI.update();
                GameUI.log("ğŸ® æ¸¸æˆå¼€å§‹ï¼è¸å…¥ä¿®ä»™ä¹‹è·¯...");
                GameUI.log("ğŸ’¡ æç¤ºï¼šæŒ‰ ` é”®å¯åˆ‡æ¢è°ƒè¯•æ¨¡å¼");
                console.log("========== æ¸¸æˆåˆå§‹åŒ–å…¨éƒ¨å®Œæˆ ==========");
                
                GameState.gameStarted = true;
                
            } catch (error) {
                console.error("ã€è‡´å‘½é”™è¯¯ã€‘æ¸¸æˆåˆå§‹åŒ–å¤±è´¥:", error);
                alert("æ¸¸æˆå¯åŠ¨å¤±è´¥:\n" + error.message + "\n\nè¯·æŒ‰F12æŸ¥çœ‹æ§åˆ¶å°è¯¦æƒ…");
                throw error;
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            console.log("========== DOMContentLoaded äº‹ä»¶è§¦å‘ ==========");
            const debugInfo = document.getElementById('debugInfo');
            const loadStatus = document.getElementById('loadStatus');
            if (debugInfo) debugInfo.style.display = 'block';
            if (loadStatus) loadStatus.textContent = 'çŠ¶æ€: DOMåŠ è½½å®Œæˆ';
            
            checkFunctions();
            
            // æ–°å¢ï¼šç»‘å®šå¼ºåˆ¶å¯åŠ¨æŒ‰é’®
            const forceStartBtn = document.getElementById('forceStartBtn');
            if (forceStartBtn) {
                forceStartBtn.onclick = null; // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„å†…è”äº‹ä»¶
                forceStartBtn.addEventListener('click', function() {
                    console.log("ã€å¼ºåˆ¶å¯åŠ¨æŒ‰é’®ã€‘è¢«ç‚¹å‡»");
                    forceStart();
                });
            } else {
                console.error("ã€é”™è¯¯ã€‘æ‰¾ä¸åˆ°å¼ºåˆ¶å¯åŠ¨æŒ‰é’®ï¼");
            }
            
            setTimeout(function() {
                const startBtn = document.getElementById('startBtn');
                if (startBtn) {
                    startBtn.onclick = null;
                    startBtn.addEventListener('click', function() {
                        console.log("ã€æŒ‰é’®ç‚¹å‡»ã€‘å¼€å§‹æ¸¸æˆ");
                        startGame();
                    });
                    if (loadStatus) loadStatus.textContent = 'çŠ¶æ€: æŒ‰é’®å·²å°±ç»ª';
                } else {
                    console.error("ã€é”™è¯¯ã€‘æ‰¾ä¸åˆ°å¼€å§‹æŒ‰é’®ï¼");
                }
            }, 100);
            
            console.log("========== åˆå§‹åŒ–è„šæœ¬æ‰§è¡Œå®Œæ¯• ==========");
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === '`') {
                toggleDebug();
            }
        });
    </script>
</body>
</html>
